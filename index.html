<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elaine & Walter - El√©trica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; padding-bottom: 90px; }
        h1, h2, h3, .fun-font { font-family: 'Fredoka', sans-serif; }
        
        @media (min-width: 768px) { 
            body { height: 100vh; overflow: hidden; padding-bottom: 0; display: flex; flex-direction: column; } 
            .scroll-area { flex: 1; overflow-y: auto; }
        }
        
        .tab-content { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .tab-content.active { display: block; opacity: 1; }
        
        .card-hover { transition: transform 0.2s, box-shadow 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }

        /* Phase Colors */
        .phase-r { background-color: #ef4444; color: white; }
        .phase-s { background-color: #1e293b; color: white; }
        .phase-t { background-color: #eab308; color: black; }
        
        .auth-tab { cursor: pointer; padding-bottom: 8px; border-bottom: 3px solid transparent; color: #94a3b8; transition: all 0.2s; }
        .auth-tab.active { border-color: #6366f1; color: #6366f1; font-weight: 700; }

        /* Filtros Ativos */
        .filter-btn { transition: all 0.2s; border: 1px solid #e2e8f0; }
        .filter-btn.active { background-color: #4338ca; color: white; border-color: #4338ca; box-shadow: 0 4px 6px -1px rgba(67, 56, 202, 0.4); }
        .filter-btn:not(.active) { background-color: white; color: #64748b; }
        .filter-btn:not(.active):hover { background-color: #f8fafc; }

        /* Tabela Or√ßamento Responsiva */
        .budget-table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 1rem; border: 1px solid #e2e8f0; }
        .budget-table th, .budget-table td { white-space: nowrap; }
    </style>
</head>
<body class="text-slate-800 bg-slate-50">

    <!-- TELA LOGIN -->
    <div id="auth-screen" class="fixed inset-0 bg-gradient-to-br from-indigo-600 to-violet-600 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-8 relative overflow-hidden">
            <div class="text-center mb-6">
                <div class="bg-indigo-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl shadow-inner">‚ö°</div>
                <h1 class="text-3xl font-bold text-slate-800 mb-1">Elaine & Walter</h1>
                <p class="text-slate-500 text-sm font-medium">Projeto El√©trico Inteligente</p>
            </div>

            <div class="flex justify-center gap-8 mb-6 border-b border-slate-100">
                <div onclick="window.app.switchAuthMode('login')" id="tab-login" class="auth-tab active">Entrar</div>
                <div onclick="window.app.switchAuthMode('register')" id="tab-register" class="auth-tab">Criar Conta</div>
            </div>

            <div class="space-y-4">
                <input id="auth-email" type="email" class="w-full border-2 border-slate-100 rounded-xl p-3.5 outline-none focus:border-indigo-500 transition bg-slate-50 focus:bg-white font-medium text-slate-700" placeholder="Seu e-mail">
                <input id="auth-pass" type="password" class="w-full border-2 border-slate-100 rounded-xl p-3.5 outline-none focus:border-indigo-500 transition bg-slate-50 focus:bg-white font-medium text-slate-700" placeholder="Senha secreta">
                
                <div id="auth-error" class="hidden bg-red-50 border border-red-100 rounded-xl p-3 text-center">
                    <p id="auth-error-text" class="text-red-600 text-xs font-bold"></p>
                </div>

                <button onclick="window.app.handleAuthAction()" id="btn-auth-action" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition transform active:scale-[0.98] text-lg">
                    ACESSAR PROJETO
                </button>
            </div>
            <p class="text-center text-[10px] text-slate-300 mt-6">Resid√™ncia Unifamiliar - PB</p>
        </div>
    </div>

    <!-- APP INTERFACE -->
    <div id="app-interface" class="hidden flex-col h-full">
        <!-- HEADER -->
        <header class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm z-20 sticky top-0">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-yellow-400 to-orange-500 text-white p-2.5 rounded-xl shadow-lg shadow-orange-200 transform -rotate-3">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12H11l2-8z"/></svg>
                </div>
                <div>
                    <h1 class="font-bold text-xl text-slate-800 leading-none fun-font">Projeto El√©trico</h1>
                    <p class="text-[10px] font-bold text-indigo-500 tracking-wide uppercase mt-0.5">Elaine & Walter</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="hidden md:flex bg-slate-100 p-1.5 rounded-xl gap-1">
                    <button onclick="window.app.setTab('rooms')" id="nav-rooms" class="px-4 py-2 rounded-lg text-xs font-bold transition bg-white shadow-sm text-indigo-600">üè° C√¥modos</button>
                    <button onclick="window.app.setTab('circuits')" id="nav-circuits" class="px-4 py-2 rounded-lg text-xs font-bold transition text-slate-500 hover:text-slate-900 hover:bg-white">‚ö° Circuitos</button>
                    <button onclick="window.app.setTab('bom')" id="nav-bom" class="px-4 py-2 rounded-lg text-xs font-bold transition text-slate-500 hover:text-slate-900 hover:bg-white">üìã Materiais</button>
                    <button onclick="window.app.setTab('budget')" id="nav-budget" class="px-4 py-2 rounded-lg text-xs font-bold transition text-slate-500 hover:text-slate-900 hover:bg-white">üí∞ Custos</button>
                </div>
                <button onclick="window.app.handleLogout()" class="bg-red-50 text-red-500 hover:bg-red-100 p-2.5 rounded-xl transition" title="Sair">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </div>
        </header>

        <!-- CONTE√öDO PRINCIPAL -->
        <main class="scroll-area p-4 md:p-8 max-w-7xl mx-auto w-full space-y-8 h-full">
            
            <!-- ABA 1: C√îMODOS -->
            <div id="tab-rooms" class="tab-content active">
                <div class="flex flex-col md:flex-row justify-between md:items-end mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 fun-font">Ambientes da Casa</h2>
                        <p class="text-slate-500 text-sm font-medium">Filtre por andar para facilitar a vis√£o.</p>
                    </div>
                    <button onclick="window.app.promptAddRoom()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 transition transform active:scale-95 flex items-center justify-center gap-2 w-full md:w-auto">
                        <span class="text-xl leading-none">+</span> Novo C√¥modo
                    </button>
                </div>

                <!-- Filtros de Andar (CORRIGIDO) -->
                <div class="flex gap-2 mb-6 overflow-x-auto pb-2 snap-x">
                    <button onclick="window.app.filterFloor('all', this)" class="filter-btn active snap-start shrink-0 px-5 py-2 rounded-full text-xs font-bold shadow-sm">Todos</button>
                    <button onclick="window.app.filterFloor('subsolo', this)" class="filter-btn snap-start shrink-0 px-5 py-2 rounded-full text-xs font-bold shadow-sm">Subsolo üöó</button>
                    <button onclick="window.app.filterFloor('terreo', this)" class="filter-btn snap-start shrink-0 px-5 py-2 rounded-full text-xs font-bold shadow-sm">T√©rreo üè†</button>
                    <button onclick="window.app.filterFloor('superior', this)" class="filter-btn snap-start shrink-0 px-5 py-2 rounded-full text-xs font-bold shadow-sm">1¬∫ Andar üõå</button>
                </div>

                <div id="rooms-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
                    <!-- Preenchido via JS -->
                </div>
            </div>

            <!-- ABA 2: CIRCUITOS E BALANCEAMENTO -->
            <div id="tab-circuits" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 fun-font">Quadros de Distribui√ß√£o</h2>
                        <p class="text-slate-500 text-sm">Equil√≠brio de fases (R, S, T).</p>
                    </div>
                    <button onclick="window.app.promptAddCircuit()" class="bg-indigo-600 text-white px-4 py-2.5 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center gap-2">
                        <span>‚ö°</span> Novo Circuito
                    </button>
                </div>

                <div class="grid grid-cols-3 gap-3 mb-8">
                    <div class="bg-white p-3 rounded-2xl border-b-4 border-red-500 shadow-sm flex flex-col items-center">
                        <div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center mb-1 font-bold">R</div>
                        <div id="load-r" class="text-lg md:text-2xl font-black text-slate-800">0 W</div>
                    </div>
                    <div class="bg-white p-3 rounded-2xl border-b-4 border-slate-800 shadow-sm flex flex-col items-center">
                         <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-800 flex items-center justify-center mb-1 font-bold">S</div>
                        <div id="load-s" class="text-lg md:text-2xl font-black text-slate-800">0 W</div>
                    </div>
                    <div class="bg-white p-3 rounded-2xl border-b-4 border-yellow-400 shadow-sm flex flex-col items-center">
                         <div class="w-8 h-8 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center mb-1 font-bold">T</div>
                        <div id="load-t" class="text-lg md:text-2xl font-black text-slate-800">0 W</div>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-8">
                    <div class="bg-slate-50 rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="bg-white px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2">üè† Quadro T√©rreo</h3>
                            <span class="text-[10px] font-bold bg-green-100 text-green-700 px-2 py-1 rounded-lg">Principal</span>
                        </div>
                        <div id="list-qd-terreo" class="p-3 space-y-2"></div>
                    </div>
                    <div class="bg-slate-50 rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="bg-white px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2">üõå Quadro 1¬∫ Andar</h3>
                            <span class="text-[10px] font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded-lg">Secund√°rio</span>
                        </div>
                        <div id="list-qd-superior" class="p-3 space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- ABA 3: MATERIAIS -->
            <div id="tab-bom" class="tab-content">
                <h2 class="text-2xl font-bold text-slate-800 fun-font mb-6">Lista de Materiais</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><span class="text-xl">üì¶</span> Itens e Acabamentos</h3>
                        <div id="bom-devices" class="space-y-3"></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 relative overflow-hidden">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><span class="text-xl">üß∂</span> Cabos (Estimativa)</h3>
                        <div id="bom-cables" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- ABA 4: OR√áAMENTO (CORRIGIDA) -->
            <div id="tab-budget" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 fun-font">Or√ßamento</h2>
                        <p class="text-slate-500 text-sm">Valores de Jo√£o Pessoa - PB</p>
                    </div>
                    <button onclick="window.app.confirmReset()" class="text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg text-xs font-bold transition border border-red-100">Resetar</button>
                </div>
                
                <div class="bg-white shadow-sm budget-table-container">
                    <table class="w-full text-left text-sm budget-table">
                        <thead class="bg-slate-50 text-slate-500 border-b border-slate-200">
                            <tr>
                                <th class="p-4 font-semibold sticky left-0 bg-slate-50 z-10 shadow-[1px_0_0_0_rgba(0,0,0,0.05)]">Item</th>
                                <th class="p-4 font-semibold text-center">Qtd</th>
                                <th class="p-4 font-semibold text-right">Unit. (R$)</th>
                                <th class="p-4 font-semibold text-right pr-6">Total</th>
                            </tr>
                        </thead>
                        <tbody id="budget-tbody" class="divide-y divide-slate-100"></tbody>
                        <tfoot class="bg-slate-900 text-white font-bold text-lg">
                            <tr>
                                <td class="p-5 sticky left-0 bg-slate-900 z-10">TOTAL GERAL</td>
                                <td colspan="3" id="budget-total" class="p-5 text-right text-yellow-400 pr-6">R$ 0,00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <p class="text-center text-slate-400 text-xs mt-4">Arraste a tabela para o lado para ver mais detalhes ‚ÜîÔ∏è</p>
            </div>

        </main>
    </div>

    <!-- MENU MOBILE -->
    <div id="mobile-menu" class="md:hidden hidden fixed bottom-0 w-full bg-white/95 backdrop-blur border-t border-slate-200 p-2 justify-around z-40 shadow-[0_-4px_15px_rgba(0,0,0,0.05)] safe-area-pb">
        <button onclick="window.app.setTab('rooms')" id="mob-rooms" class="flex-1 py-1 text-indigo-600 flex flex-col items-center gap-1">
            <span class="text-xl">üè°</span><span class="text-[10px] font-bold">C√¥modos</span>
        </button>
        <button onclick="window.app.setTab('circuits')" id="mob-circuits" class="flex-1 py-1 text-slate-400 flex flex-col items-center gap-1">
            <span class="text-xl">‚ö°</span><span class="text-[10px] font-bold">Circuitos</span>
        </button>
        <button onclick="window.app.setTab('bom')" id="mob-bom" class="flex-1 py-1 text-slate-400 flex flex-col items-center gap-1">
            <span class="text-xl">üìã</span><span class="text-[10px] font-bold">Lista</span>
        </button>
        <button onclick="window.app.setTab('budget')" id="mob-budget" class="flex-1 py-1 text-slate-400 flex flex-col items-center gap-1">
            <span class="text-xl">üí∞</span><span class="text-[10px] font-bold">R$</span>
        </button>
    </div>

    <!-- MODAIS -->
    <div id="generic-modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6">
            <h3 id="g-modal-title" class="text-xl font-bold text-slate-800 mb-2 fun-font"></h3>
            <p id="g-modal-desc" class="text-sm text-slate-500 mb-4 hidden"></p>
            <input id="g-modal-input" class="w-full border-2 border-slate-200 rounded-xl p-3 mb-4 hidden outline-none focus:border-indigo-500 text-slate-700 font-medium" autocomplete="off">
            <div class="flex justify-end gap-3 mt-2">
                <button onclick="window.app.closeModal()" class="px-5 py-2 text-slate-500 font-bold text-xs">Cancelar</button>
                <button id="g-modal-confirm-btn" class="px-5 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-bold text-xs shadow-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="item-modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-xl font-bold text-slate-800 fun-font">Adicionar Ponto</h3>
                <button onclick="window.app.closeItemModal()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-red-100 hover:text-red-500">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wide">Item</label>
                        <select id="i-type" class="w-full border-2 border-slate-200 rounded-xl p-3 bg-slate-50 outline-none text-sm font-medium focus:border-indigo-500">
                            <option value="light">üí° Luz</option>
                            <option value="outlet">üîå Tomada 10A</option>
                            <option value="outlet20">üõë Tomada 20A</option>
                            <option value="switch">üîò Interruptor</option>
                            <option value="equipment">‚ùÑÔ∏è Ar/Chuv</option>
                        </select>
                    </div>
                    <div>
                         <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wide">Pot√™ncia (W)</label>
                        <input id="i-watt" type="number" class="w-full border-2 border-slate-200 rounded-xl p-3 outline-none focus:border-indigo-500 text-sm font-medium" value="100">
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wide">Nome</label>
                    <input id="i-name" class="w-full border-2 border-slate-200 rounded-xl p-3 outline-none focus:border-indigo-500 text-sm font-medium" placeholder="Ex: Tomada Geladeira">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wide">Circuito</label>
                    <select id="i-circ" class="w-full border-2 border-slate-200 rounded-xl p-3 bg-white outline-none focus:border-indigo-500 text-sm font-medium"></select>
                </div>
                <button id="item-save-btn" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 mt-2">Salvar</button>
            </div>
        </div>
    </div>

    <div id="circuit-modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold text-slate-800 fun-font mb-4">Configurar Circuito</h3>
            <div class="space-y-4">
                <input id="c-name" class="w-full border-2 border-slate-200 rounded-xl p-3 outline-none focus:border-indigo-500 text-sm font-medium" placeholder="Nome (Ex: Ilumina√ß√£o T√©rreo)">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">Quadro</label>
                        <select id="c-qd" class="w-full border-2 border-slate-200 rounded-xl p-3 bg-slate-50 outline-none text-sm">
                            <option value="terreo">üè† T√©rreo</option>
                            <option value="superior">üõå 1¬∫ Andar</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">Fase</label>
                        <select id="c-phase" class="w-full border-2 border-slate-200 rounded-xl p-3 bg-slate-50 outline-none text-sm">
                            <option value="r">üî¥ Vermelha (R)</option>
                            <option value="s">‚ö´ Preta (S)</option>
                            <option value="t">üü° Amarela (T)</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">Fio (mm¬≤)</label>
                        <select id="c-gauge" class="w-full border-2 border-slate-200 rounded-xl p-3 bg-slate-50 outline-none text-sm">
                            <option value="1.5">1.5 mm¬≤</option>
                            <option value="2.5">2.5 mm¬≤</option>
                            <option value="4.0">4.0 mm¬≤</option>
                            <option value="6.0">6.0 mm¬≤</option>
                            <option value="10.0">10.0 mm¬≤</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">Dist. (m)</label>
                        <input id="c-dist" type="number" class="w-full border-2 border-slate-200 rounded-xl p-3 outline-none text-sm" value="15">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-4">
                    <button onclick="document.getElementById('circuit-modal').classList.add('hidden')" class="px-5 py-2 text-slate-500 font-bold text-xs">Cancelar</button>
                    <button id="c-save-btn" class="px-5 py-2 bg-indigo-600 text-white rounded-xl font-bold text-xs shadow-lg">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByJ0jEYJm1ZbwJEWJy5uTwCVn2M3LA644",
            authDomain: "elainehouse-c4b4b.firebaseapp.com",
            projectId: "elainehouse-c4b4b",
            storageBucket: "elainehouse-c4b4b.firebasestorage.app",
            messagingSenderId: "105394705921",
            appId: "1:105394705921:web:63c7993c59514ecd3ad200",
            measurementId: "G-TKZ37YREMG"
        };

        const defaultData = {
            rooms: [
                { id: 1, name: "üöó Garagem (Subsolo)", floor: "subsolo", items: [] },
                { id: 2, name: "üõãÔ∏è Sala Estar/Jantar", floor: "terreo", items: [] },
                { id: 3, name: "üç≥ Cozinha", floor: "terreo", items: [] },
                { id: 4, name: "üçñ Terra√ßo Gourmet", floor: "terreo", items: [] },
                { id: 5, name: "üõèÔ∏è Quarto 01 (T√©rreo)", floor: "terreo", items: [] },
                { id: 6, name: "üöΩ WCB 01 Social", floor: "terreo", items: [] },
                { id: 7, name: "üßπ √Årea de Servi√ßo", floor: "terreo", items: [] },
                { id: 8, name: "üì¶ Dep√≥sito", floor: "terreo", items: [] },
                { id: 9, name: "üèä Deck / Piscina", floor: "terreo", items: [] },
                { id: 10, name: "üëë Su√≠te Master", floor: "superior", items: [] },
                { id: 11, name: "üëó Closet Master", floor: "superior", items: [] },
                { id: 12, name: "üöø WCB Su√≠te", floor: "superior", items: [] },
                { id: 13, name: "üñ•Ô∏è Escrit√≥rio", floor: "superior", items: [] },
                { id: 14, name: "üõèÔ∏è Quarto 02", floor: "superior", items: [] },
                { id: 15, name: "üõèÔ∏è Quarto 03", floor: "superior", items: [] },
                { id: 16, name: "üöΩ WCB 03 Social", floor: "superior", items: [] },
                { id: 17, name: "üö∂ Circula√ß√£o Sup.", floor: "superior", items: [] }
            ],
            circuits: [
                { id: 1, name: "Ilumina√ß√£o T√©rreo", qd: "terreo", phase: "r", gauge: "1.5", dist: 20 },
                { id: 2, name: "TUGs Cozinha", qd: "terreo", phase: "s", gauge: "2.5", dist: 15 },
                { id: 3, name: "Ar Cond. Su√≠te", qd: "superior", phase: "t", gauge: "4.0", dist: 25 },
                { id: 4, name: "Chuveiro Master", qd: "superior", phase: "r", gauge: "6.0", dist: 20 }
            ],
            prices: { outlet: 14.50, outlet20: 18.90, light: 25.00, switch: 12.00, equipment: 0, breaker: 18.50, 'cable1.5': 1.60, 'cable2.5': 2.40, 'cable4.0': 4.80, 'cable6.0': 7.50, 'cable10.0': 14.00, board: 135.00 }
        };

        let Project = JSON.parse(JSON.stringify(defaultData));
        let DB_REF = null;
        let SAVE_TIMER = null;
        let AUTH = null;
        let currentAuthMode = 'login';
        let currentFloorFilter = 'all';

        window.onload = () => {
            try {
                const app = initializeApp(firebaseConfig);
                AUTH = getAuth(app);
                const db = getFirestore(app);
                
                onAuthStateChanged(AUTH, (user) => {
                    if (user) {
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('app-interface').classList.remove('hidden');
                        document.getElementById('app-interface').classList.add('flex');
                        document.getElementById('mobile-menu').classList.remove('hidden');
                        document.getElementById('mobile-menu').classList.add('flex');
                        DB_REF = doc(db, `users/${user.uid}/data/project_elaine_walter_v2`);
                        onSnapshot(DB_REF, (snap) => {
                            if (snap.exists()) {
                                Project = snap.data();
                                if(!Project.rooms) Project = JSON.parse(JSON.stringify(defaultData));
                                renderAll();
                            } else { saveCloud(true); }
                        });
                    } else {
                        document.getElementById('auth-screen').classList.remove('hidden');
                        document.getElementById('app-interface').classList.add('hidden');
                        document.getElementById('app-interface').classList.remove('flex');
                        document.getElementById('mobile-menu').classList.add('hidden');
                        document.getElementById('mobile-menu').classList.remove('flex');
                        DB_REF = null;
                    }
                });
            } catch (e) { console.error(e); }
        };

        window.app = window.app || {};
        window.app.switchAuthMode = (mode) => {
            currentAuthMode = mode;
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + mode).classList.add('active');
            document.getElementById('btn-auth-action').innerText = mode === 'login' ? 'ACESSAR PROJETO' : 'CRIAR CONTA';
            document.getElementById('auth-error').classList.add('hidden');
        };

        window.app.handleAuthAction = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const btn = document.getElementById('btn-auth-action');
            
            if(!email || !pass) { document.getElementById('auth-error').classList.remove('hidden'); document.getElementById('auth-error-text').innerText = "Preencha tudo!"; return; }
            
            btn.innerText = "Carregando..."; btn.disabled = true;
            try {
                if(currentAuthMode === 'login') await signInWithEmailAndPassword(AUTH, email, pass);
                else await createUserWithEmailAndPassword(AUTH, email, pass);
            } catch (error) {
                btn.disabled = false; btn.innerText = "TENTAR NOVAMENTE";
                document.getElementById('auth-error').classList.remove('hidden');
                let msg = "Erro no acesso.";
                if(error.code.includes('invalid') || error.code.includes('wrong')) msg = "Email ou senha inv√°lidos.";
                if(error.code.includes('email-already')) msg = "Email j√° cadastrado.";
                if(error.code.includes('weak')) msg = "Senha muito fraca.";
                document.getElementById('auth-error-text').innerText = msg;
            }
        };
        
        window.app.handleLogout = () => signOut(AUTH).then(() => window.location.reload());

        function saveCloud(immediate = false) {
            if (DB_REF) {
                clearTimeout(SAVE_TIMER);
                const save = () => setDoc(DB_REF, Project).catch(console.error);
                if(immediate) save(); else SAVE_TIMER = setTimeout(save, 1000);
            }
            renderAll();
        }

        function renderAll() { renderRooms(); renderCircuits(); renderBOM(); renderBudget(); }
        window.app.setTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('nav button, #mobile-menu button').forEach(b => {
                b.classList.remove('text-indigo-600', 'bg-white', 'shadow-sm'); b.classList.add('text-slate-500');
            });
            document.querySelectorAll(`#nav-${id}, #mob-${id}`).forEach(b => {
                b.classList.add('text-indigo-600', 'bg-white', 'shadow-sm'); b.classList.remove('text-slate-500');
            });
        };

        // --- FILTRO CORRIGIDO ---
        window.app.filterFloor = (floor, btnElement) => {
            currentFloorFilter = floor;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            renderRooms();
        }

        function renderRooms() {
            const grid = document.getElementById('rooms-grid'); grid.innerHTML = '';
            const filtered = currentFloorFilter === 'all' ? Project.rooms : Project.rooms.filter(r => r.floor === currentFloorFilter);

            filtered.forEach(r => {
                const badge = r.floor === 'subsolo' ? "bg-gray-100 text-gray-500" : (r.floor === 'terreo' ? "bg-green-50 text-green-600" : "bg-blue-50 text-blue-600");
                const itemsHtml = r.items.map(i => `
                    <div class="flex justify-between items-center py-2 border-b border-slate-50 last:border-0 group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-xl bg-slate-50 flex items-center justify-center text-lg shadow-sm">
                                ${i.type==='light'?'üí°':i.type==='outlet'?'üîå':i.type==='outlet20'?'üõë':i.type==='switch'?'üîò':'‚ùÑÔ∏è'}
                            </div>
                            <div><p class="text-xs font-bold text-slate-700 leading-none mb-0.5">${i.name}</p><div class="flex items-center gap-1"><span class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-mono">${i.power}W</span>${getCircuitBadge(i.circuitId)}</div></div>
                        </div>
                        <button onclick="window.app.delItem(${r.id}, ${i.id})" class="text-slate-300 hover:text-red-500 p-1.5 rounded-lg transition opacity-0 group-hover:opacity-100">‚úï</button>
                    </div>`).join('');

                grid.innerHTML += `
                    <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200 card-hover flex flex-col relative">
                        <div class="flex justify-between items-start mb-3">
                            <div><span class="text-[9px] uppercase font-bold tracking-wider px-2 py-1 rounded-md ${badge} mb-1 inline-block">${r.floor}</span><h3 class="font-bold text-lg text-slate-800 fun-font leading-tight">${r.name}</h3></div>
                            <div class="flex gap-1"><button onclick="window.app.addItem(${r.id})" class="bg-indigo-50 text-indigo-600 hover:bg-indigo-100 w-8 h-8 rounded-xl flex items-center justify-center font-bold text-lg transition shadow-sm">+</button><button onclick="window.app.delRoom(${r.id})" class="text-slate-300 hover:text-red-400 hover:bg-red-50 w-8 h-8 rounded-xl flex items-center justify-center transition">üóëÔ∏è</button></div>
                        </div>
                        <div class="flex-1 space-y-1 mb-2">${itemsHtml || '<div class="h-20 flex items-center justify-center text-xs text-slate-300 italic border-2 border-dashed border-slate-100 rounded-xl">Sem itens</div>'}</div>
                    </div>`;
            });
        }

        function renderCircuits() {
            const qdT = document.getElementById('list-qd-terreo'); const qdS = document.getElementById('list-qd-superior'); qdT.innerHTML = ''; qdS.innerHTML = '';
            let loads = { r:0, s:0, t:0 };
            Project.circuits.forEach(c => {
                let w = 0; Project.rooms.forEach(r => r.items.forEach(i => { if(i.circuitId == c.id) w += (i.power||0); }));
                if(loads[c.phase] !== undefined) loads[c.phase] += w;
                let phClass = c.phase === 'r' ? 'phase-r' : (c.phase === 's' ? 'phase-s' : 'phase-t');
                const html = `<div class="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition group"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg ${phClass} flex items-center justify-center text-xs font-bold shadow-sm uppercase">${c.phase}</div><div><p class="text-sm font-bold text-slate-700 leading-none mb-0.5">${c.name}</p><p class="text-[10px] text-slate-400 font-mono">${w}W ‚Ä¢ Fio ${c.gauge}mm¬≤</p></div></div><button onclick="window.app.delCirc(${c.id})" class="text-slate-300 hover:text-red-500 p-1.5 opacity-0 group-hover:opacity-100 transition">‚úï</button></div>`;
                if(c.qd === 'terreo') qdT.innerHTML += html; else qdS.innerHTML += html;
            });
            document.getElementById('load-r').innerText = loads.r + ' W'; document.getElementById('load-s').innerText = loads.s + ' W'; document.getElementById('load-t').innerText = loads.t + ' W';
        }

        function getCircuitBadge(id) {
            const c = Project.circuits.find(x => x.id == id); if(!c) return '';
            let color = c.phase === 'r' ? 'text-red-500' : (c.phase === 's' ? 'text-slate-800' : 'text-yellow-600');
            return `<span class="text-[9px] font-bold ${color} bg-slate-50 px-1 rounded border border-slate-100">C${Project.circuits.indexOf(c)+1}</span>`;
        }

        function renderBOM() {
            const devices = document.getElementById('bom-devices');
            let counts = { outlet:0, outlet20:0, light:0, switch:0, equipment:0, breaker: Project.circuits.length };
            Project.rooms.forEach(r => r.items.forEach(i => { if(counts[i.type] !== undefined) counts[i.type]++; }));
            const row = (icon, name, qtd, color) => `<div class="flex justify-between items-center p-2 border-b border-slate-50 last:border-0"><div class="flex gap-3 items-center"><div class="w-8 h-8 rounded-lg ${color} flex items-center justify-center text-lg">${icon}</div><span class="text-sm font-bold text-slate-600">${name}</span></div><span class="text-lg font-bold text-slate-800">${qtd}</span></div>`;
            devices.innerHTML = `${row('üîå','Tomada 10A',counts.outlet,'bg-green-50 text-green-600')}${row('üõë','Tomada 20A',counts.outlet20,'bg-red-50 text-red-600')}${row('üîò','Interruptores',counts.switch,'bg-slate-100 text-slate-600')}${row('üí°','Luzes',counts.light,'bg-yellow-50 text-yellow-600')}${row('üõ°Ô∏è','Disjuntores',counts.breaker,'bg-blue-50 text-blue-600')}${row('‚ö°','Quadros',2,'bg-indigo-50 text-indigo-600')}`;

            const cablesEl = document.getElementById('bom-cables'); cablesEl.innerHTML = '';
            const gauges = {};
            Project.circuits.forEach(c => {
                const g = c.gauge; const d = (Number(c.dist) || 15) * 1.2;
                if(!gauges[g]) gauges[g] = 0; gauges[g] += d;
            });
            Object.keys(gauges).sort().forEach(g => {
                const m = Math.ceil(gauges[g]);
                cablesEl.innerHTML += `<div class="mb-3 pb-3 border-b border-slate-50 last:border-0"><p class="text-xs font-bold text-slate-500 uppercase mb-2">Bitola ${g}mm¬≤</p><div class="flex gap-2"><div class="flex-1 p-2 rounded bg-white border border-slate-200 flex items-center gap-2 shadow-sm"><div class="w-3 h-3 rounded-full ${g=='2.5'?'bg-red-500':g=='4.0'?'bg-blue-500':'bg-yellow-400'}"></div><div class="flex flex-col"><span class="text-[9px] text-slate-400 font-bold">FASE</span><span class="text-sm font-bold text-slate-700">${m}m</span></div></div><div class="flex-1 p-2 rounded bg-white border border-slate-200 flex items-center gap-2 shadow-sm"><div class="w-3 h-3 rounded-full bg-white border border-slate-300"></div><div class="flex flex-col"><span class="text-[9px] text-slate-400 font-bold">NEUTRO</span><span class="text-sm font-bold text-slate-700">${m}m</span></div></div><div class="flex-1 p-2 rounded bg-white border border-slate-200 flex items-center gap-2 shadow-sm"><div class="w-3 h-3 rounded-full bg-green-500"></div><div class="flex flex-col"><span class="text-[9px] text-slate-400 font-bold">TERRA</span><span class="text-sm font-bold text-slate-700">${m}m</span></div></div></div></div>`;
            });
        }

        function renderBudget() {
            const tb = document.getElementById('budget-tbody'); tb.innerHTML = ''; let total = 0;
            const count = k => {
                if(k === 'breaker') return Project.circuits.length; if(k === 'board') return 2;
                if(k.startsWith('cable')) { const g = k.replace('cable', ''); let m = 0; Project.circuits.forEach(c => { if(c.gauge == g) m += (Number(c.dist)||15)*1.2*3; }); return Math.ceil(m); }
                return Project.rooms.reduce((acc,r) => acc + r.items.filter(i=>i.type===k).length, 0);
            };
            const labels = { outlet: 'Tomada 10A', outlet20: 'Tomada 20A', light: 'Ponto Luz', switch: 'Interruptor', breaker: 'Disjuntor DIN', board: 'QDC 12/16', 'cable1.5': 'Cabo 1.5mm¬≤', 'cable2.5': 'Cabo 2.5mm¬≤', 'cable4.0': 'Cabo 4.0mm¬≤', 'cable6.0': 'Cabo 6.0mm¬≤', 'cable10.0': 'Cabo 10mm¬≤' };

            Object.keys(Project.prices).forEach(key => {
                const qtd = count(key);
                if(qtd > 0) {
                    const unit = Project.prices[key]; const sub = qtd * unit; total += sub;
                    tb.innerHTML += `<tr class="hover:bg-slate-50 transition"><td class="p-4 text-slate-700 font-medium sticky left-0 bg-white shadow-[1px_0_0_0_rgba(0,0,0,0.05)]">${labels[key]||key}</td><td class="p-4 text-center text-slate-500 font-bold">${qtd}</td><td class="p-4 text-right"><button onclick="window.app.editPrice('${key}')" class="text-indigo-600 bg-indigo-50 px-2 py-1 rounded text-xs font-bold hover:bg-indigo-100 transition">R$ ${unit.toFixed(2)}</button></td><td class="p-4 text-right font-bold text-slate-800 pr-6">R$ ${sub.toFixed(2)}</td></tr>`;
                }
            });
            document.getElementById('budget-total').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        }

        // ACTIONS & MODALS
        const modal = {
            el: document.getElementById('generic-modal'),
            open: (title, desc, hasInput, val, cb) => {
                document.getElementById('g-modal-title').innerText = title;
                const d = document.getElementById('g-modal-desc'); d.innerText = desc||''; d.classList.toggle('hidden', !desc);
                const i = document.getElementById('g-modal-input'); i.value = val||''; i.classList.toggle('hidden', !hasInput);
                modal.el.classList.remove('hidden'); modal.el.classList.add('flex'); if(hasInput) setTimeout(()=>i.focus(), 100);
                document.getElementById('g-modal-confirm-btn').onclick = () => { if(hasInput && !i.value) return; cb(i.value); modal.close(); };
            },
            close: () => { modal.el.classList.add('hidden'); modal.el.classList.remove('flex'); }
        };

        window.app.promptAddRoom = () => modal.open("Novo C√¥modo", "Nome do ambiente:", true, "", v => { Project.rooms.push({ id: Date.now(), name: v, floor: currentFloorFilter==='all'?'terreo':currentFloorFilter, items: [] }); saveCloud(); });
        window.app.delRoom = (id) => modal.open("Excluir?", "Apagar√° tudo no c√¥modo.", false, null, () => { Project.rooms = Project.rooms.filter(r => r.id !== id); saveCloud(); });
        window.app.promptAddCircuit = () => { document.getElementById('circuit-modal').classList.remove('hidden'); document.getElementById('circuit-modal').classList.add('flex'); document.getElementById('c-save-btn').onclick = () => { const n = document.getElementById('c-name').value; if(n) { Project.circuits.push({ id: Date.now(), name: n, qd: document.getElementById('c-qd').value, phase: document.getElementById('c-phase').value, gauge: document.getElementById('c-gauge').value, dist: Number(document.getElementById('c-dist').value) }); saveCloud(); document.getElementById('circuit-modal').classList.add('hidden'); } } };
        window.app.delCirc = (id) => modal.open("Apagar Circuito?", null, false, null, () => { Project.circuits = Project.circuits.filter(c => c.id !== id); saveCloud(); });
        window.app.addItem = (rid) => {
            const m = document.getElementById('item-modal'); m.classList.remove('hidden'); m.classList.add('flex');
            const sel = document.getElementById('i-circ'); sel.innerHTML = '<option value="">-- Selecione --</option>' + Project.circuits.map(c => `<option value="${c.id}">${c.name} (${c.phase.toUpperCase()})</option>`).join('');
            document.getElementById('item-save-btn').onclick = () => {
                const n = document.getElementById('i-name').value; if(n) { const r = Project.rooms.find(x => x.id === rid); if(r) { r.items.push({ id: Date.now(), type: document.getElementById('i-type').value, name: n, power: Number(document.getElementById('i-watt').value), circuitId: document.getElementById('i-circ').value }); saveCloud(); window.app.closeItemModal(); } }
            };
        };
        window.app.closeItemModal = () => { document.getElementById('item-modal').classList.add('hidden'); document.getElementById('item-modal').classList.remove('flex'); };
        window.app.delItem = (rid, iid) => modal.open("Remover Ponto?", null, false, null, () => { const r = Project.rooms.find(x => x.id === rid); if(r) { r.items = r.items.filter(i => i.id !== iid); saveCloud(); } });
        window.app.editPrice = (k) => modal.open("Editar Pre√ßo", null, true, Project.prices[k], v => { Project.prices[k] = parseFloat(v); saveCloud(); });
        window.app.confirmReset = () => modal.open("Resetar Tudo?", "Isso apaga suas altera√ß√µes.", false, null, () => { Project = JSON.parse(JSON.stringify(defaultData)); saveCloud(true); });
        window.app.closeModal = modal.close;

    </script>
</body>
</html>

