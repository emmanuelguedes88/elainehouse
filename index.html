<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Projeto El√©trico - Aula NBR 5410</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&family=Patrick+Hand&display=swap" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        h1, h2, h3, .fun-font { font-family: 'Fredoka', sans-serif; }
        
        @media (min-width: 768px) { 
            body { height: 100vh; overflow: hidden; display: flex; flex-direction: column; } 
            .scroll-area { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        }
        @media (max-width: 767px) {
            body { padding-bottom: 90px; min-height: 100vh; }
            .scroll-area { padding-bottom: 120px; }
        }
        
        .tab-content { display: none; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .tab-content.active { display: block; opacity: 1; }
        
        .card-hover { transition: all 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 16px -4px rgba(0,0,0,0.1); }

        .bg-phase-r { background-color: #ef4444; color: white; }
        .bg-phase-s { background-color: #1e293b; color: white; }
        .bg-phase-t { background-color: #facc15; color: black; }
        
        .filter-btn { transition: all 0.2s; border: 1px solid #e2e8f0; }
        .filter-btn.active { background-color: #4338ca; color: white; border-color: #4338ca; }
        
        .norm-img { width: 100%; height: auto; max-height: 250px; object-fit: contain; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer; background-color: white; }
        
        .calc-box { background-color: #f1f5f9; border-left: 4px solid #6366f1; padding: 12px; margin-top: 8px; font-family: monospace; font-size: 0.8rem; color: #334155; }
        .calc-highlight { color: #4338ca; font-weight: bold; }

        .price-input { background: transparent; border-bottom: 1px dashed #cbd5e1; text-align: right; width: 80px; font-weight: 600; color: #059669; }
        .price-input:focus { outline: none; border-color: #059669; background: #ecfdf5; }

        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 100px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.5s, bottom 0.5s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 110px; }
        
        .math-display { font-size: 1.1em; color: #1e293b; margin: 10px 0; }
    </style>
</head>
<body class="text-slate-800 bg-slate-50">

    <!-- TOAST -->
    <div id="toast">Salvo na nuvem! ‚òÅÔ∏è</div>

    <!-- LOGIN AUTOM√ÅTICO -->
    <div id="auth-screen" class="fixed inset-0 bg-gradient-to-br from-indigo-600 to-blue-500 z-50 overflow-y-auto flex items-center justify-center">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-8 relative mx-4">
            <div class="text-center mb-6">
                <div class="bg-yellow-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl border-4 border-white shadow-lg">‚ö°</div>
                <h1 class="text-2xl font-bold text-slate-800 mb-1 fun-font">Projeto El√©trico</h1>
                <p class="text-slate-500 text-xs font-medium">Sincronizando...</p>
            </div>
            <div class="space-y-4">
                <div id="loading-indicator" class="text-center py-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>
                    <p class="text-xs text-slate-400 mt-2">Conectando ao Banco de Dados</p>
                </div>
                <button id="btn-enter" onclick="window.app.handleAuthAction()" class="hidden w-full bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition text-sm active:scale-95">
                    TENTAR NOVAMENTE
                </button>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div id="app-interface" class="hidden flex-col h-full">
        <!-- HEADER -->
        <header class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm z-20 sticky top-0">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-md"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>
                <div><h1 class="font-bold text-lg text-slate-800 leading-none fun-font">Aula Pr√°tica</h1><p class="text-[10px] font-bold text-indigo-600 uppercase mt-0.5">Calculando d1 + d2 + d3 + d4 + d5</p></div>
            </div>
            <div class="flex items-center gap-2">
                <div class="hidden md:flex bg-slate-100 p-1 rounded-lg gap-1">
                    <button onclick="window.app.setTab('rooms')" id="nav-rooms" class="px-3 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all">1. Planta</button>
                    <button onclick="window.app.setTab('circuits')" id="nav-circuits" class="px-3 py-1.5 rounded-md text-xs font-bold text-slate-500 transition-all">2. Circuitos</button>
                    <button onclick="window.app.setTab('steps')" id="nav-steps" class="px-3 py-1.5 rounded-md text-xs font-bold text-slate-500 transition-all">3. AULA üéì</button>
                    <button onclick="window.app.setTab('bom')" id="nav-bom" class="px-3 py-1.5 rounded-md text-xs font-bold text-slate-500 transition-all">4. Or√ßamento</button>
                </div>
            </div>
        </header>

        <!-- MAIN -->
        <main class="scroll-area p-4 md:p-6 max-w-7xl mx-auto w-full space-y-6">
            
            <!-- ABA 1: PLANTA (C√îMODOS) -->
            <div id="tab-rooms" class="tab-content active">
                <div class="flex justify-between items-end mb-4">
                    <div><h2 class="text-xl font-bold text-slate-800 fun-font">Defina os C√¥modos</h2><p class="text-slate-500 text-xs">A ilumina√ß√£o e as tomadas ser√£o sugeridas pela <b>√ÅREA</b>.</p></div>
                    <button onclick="window.app.promptAddRoom()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold shadow-lg text-sm flex items-center gap-1 hover:bg-indigo-700 transition transform active:scale-95"><span>+</span> C√¥modo</button>
                </div>
                <div class="flex gap-2 mb-4 overflow-x-auto pb-1 snap-x">
                    <button onclick="window.app.filterFloor('all', this)" class="filter-btn active snap-start px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap">Todos</button>
                    <button onclick="window.app.filterFloor('subsolo', this)" class="filter-btn snap-start px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap">Subsolo</button>
                    <button onclick="window.app.filterFloor('terreo', this)" class="filter-btn snap-start px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap">T√©rreo</button>
                    <button onclick="window.app.filterFloor('superior', this)" class="filter-btn snap-start px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap">Superior</button>
                </div>
                <div id="rooms-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- ABA 2: C√ÅLCULOS (CIRCUITOS) -->
            <div id="tab-circuits" class="tab-content">
                <h3 class="font-bold text-slate-700 text-sm uppercase tracking-wide mb-2">‚öñÔ∏è Balanceamento de Fases</h3>
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-white p-3 rounded-xl border-b-4 border-red-500 shadow-sm text-center"><span class="text-[10px] font-bold text-slate-400 uppercase">Fase R</span><div id="load-r-w" class="text-lg font-black text-red-600">0 W</div><div id="load-r-a" class="text-[10px] font-mono text-slate-500">0.0 A</div></div>
                    <div class="bg-white p-3 rounded-xl border-b-4 border-slate-900 shadow-sm text-center"><span class="text-[10px] font-bold text-slate-400 uppercase">Fase S</span><div id="load-s-w" class="text-lg font-black text-slate-900">0 W</div><div id="load-s-a" class="text-[10px] font-mono text-slate-500">0.0 A</div></div>
                    <div class="bg-white p-3 rounded-xl border-b-4 border-yellow-400 shadow-sm text-center"><span class="text-[10px] font-bold text-slate-400 uppercase">Fase T</span><div id="load-t-w" class="text-lg font-black text-yellow-600">0 W</div><div id="load-t-a" class="text-[10px] font-mono text-slate-500">0.0 A</div></div>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-slate-700 text-sm uppercase tracking-wide">Quadro de Distribui√ß√£o</h3>
                    <button onclick="window.app.promptAddCircuit()" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow hover:bg-indigo-700">+ Circuito</button>
                </div>
                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="space-y-3"><div class="flex justify-between items-center px-2"><h3 class="font-bold text-slate-700">üè† QD T√©rreo</h3><span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded font-bold">Quadro 1</span></div><div id="list-qd-terreo" class="space-y-2"></div></div>
                    <div class="space-y-3"><div class="flex justify-between items-center px-2"><h3 class="font-bold text-slate-700">üõå QD Superior</h3><span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">Quadro 2</span></div><div id="list-qd-superior" class="space-y-2"></div></div>
                </div>
            </div>

            <!-- ABA 3: MEM√ìRIA DID√ÅTICA (AULA) -->
            <div id="tab-steps" class="tab-content">
                <div class="max-w-6xl mx-auto">
                    <!-- Cabe√ßalho Aula -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8 flex flex-col md:flex-row gap-6 items-center">
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold text-indigo-900 fun-font mb-2">Como calcular a Demanda? üßÆ</h2>
                            <p class="text-slate-600 text-sm mb-4">N√£o basta somar tudo! Precisamos aplicar os <b>Fatores de Demanda</b>. Nem todas as luzes e chuveiros ficam ligados ao mesmo tempo.</p>
                            <div class="bg-slate-100 p-3 rounded-lg font-mono text-center text-indigo-700 font-bold border border-slate-200">d = d1 + d2 + d3 + d4 + d5</div>
                        </div>
                        <div class="w-full md:w-1/3 text-center">
                            <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Refer√™ncia Oficial:</p>
                            <img id="img-formula" src="" alt="F√≥rmula Demanda" class="norm-img" onclick="window.open(this.src, '_blank')">
                        </div>
                    </div>

                    <!-- TEORIA -->
                    <div class="mb-10 p-5 bg-blue-50 rounded-xl border border-blue-100">
                        <h2 class="text-xl font-bold text-blue-900 fun-font mb-4 flex items-center gap-2"><span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">0</span>Teoria: Previs√£o de Cargas</h2>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <h3 class="font-bold text-slate-800 mb-2 border-b pb-2">üí° Ilumina√ß√£o (VA)</h3>
                                <img id="img-didatico-luz" src="" class="norm-img h-32 object-top mb-2" onclick="window.open(this.src, '_blank')">
                                <ul class="list-disc ml-5 text-xs text-slate-500 space-y-1"><li>At√© 6m¬≤: <b>100 VA</b></li><li>> 6m¬≤: <b>100 VA</b> + <b>60 VA</b> a cada 4m¬≤ excedentes.</li></ul>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <h3 class="font-bold text-slate-800 mb-2 border-b pb-2">üîå Tomadas (TUGs)</h3>
                                <img id="img-didatico-tug" src="" class="norm-img h-32 object-top mb-2" onclick="window.open(this.src, '_blank')">
                                <ul class="list-disc ml-5 text-xs text-slate-500 space-y-1"><li><b>Banheiros:</b> Min 1 de 600 VA.</li><li><b>Cozinha:</b> 3 de 600 VA, resto 100 VA.</li></ul>
                            </div>
                        </div>
                    </div>

                    <!-- C√ÅLCULOS POR C√îMODO -->
                    <div class="mb-10">
                        <h2 class="text-xl font-bold text-slate-800 fun-font mb-4 flex items-center gap-2"><span class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>Calculadora: Seus C√¥modos</h2>
                        <div id="room-calc-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>

                    <div class="h-px bg-slate-200 my-8"></div>

                    <!-- REFER√äNCIAS E RESULTADOS -->
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-slate-700 mb-2">Tabelas de Pot√™ncia (NDU)</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <img id="img-tab4-1" src="" class="norm-img" alt="Tabela 4" onclick="window.open(this.src, '_blank')">
                            <img id="img-tab4-2" src="" class="norm-img" alt="Tabela 4 cont" onclick="window.open(this.src, '_blank')">
                        </div>
                    </div>
                    <div id="calc-steps-content" class="space-y-12 pb-12"></div>
                </div>
            </div>

            <!-- ABA 4: OR√áAMENTO -->
            <div id="tab-bom" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800 fun-font">Or√ßamento Estimado üí∞</h2>
                        <p class="text-xs text-slate-500">Jo√£o Pessoa, PB (Edit√°vel)</p>
                    </div>
                    <div class="bg-green-100 text-green-800 px-4 py-2 rounded-xl text-right shadow-sm">
                        <p class="text-[10px] uppercase font-bold">Total</p>
                        <p id="bom-total-price" class="text-xl font-black">R$ 0,00</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-x-auto mb-8">
                    <table class="w-full text-sm text-left min-w-[400px]">
                        <thead class="bg-slate-50 text-slate-500 font-bold text-xs uppercase">
                            <tr>
                                <th class="p-3 whitespace-nowrap">Item</th>
                                <th class="p-3 text-center">Qtd</th>
                                <th class="p-3 text-right">Unit. (R$)</th>
                                <th class="p-3 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="bom-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
                <p class="text-[10px] text-slate-400 text-center italic">*A estimativa de cabos √© baseada na dist√¢ncia informada nos circuitos x 2.5 (fator de sobra/curvas).</p>
            </div>
        </main>
    </div>

    <!-- MENU MOBILE -->
    <div id="mobile-menu" class="md:hidden hidden fixed bottom-0 w-full bg-white border-t border-slate-200 p-2 justify-around z-40 shadow-lg safe-area-pb">
        <button onclick="window.app.setTab('rooms')" id="mob-rooms" class="flex-1 py-1 text-indigo-600 flex flex-col items-center gap-1"><span class="text-xl">üè°</span><span class="text-[9px] font-bold">Planta</span></button>
        <button onclick="window.app.setTab('circuits')" id="mob-circuits" class="flex-1 py-1 text-slate-400 flex flex-col items-center gap-1"><span class="text-xl">‚ö°</span><span class="text-[9px] font-bold">Quadros</span></button>
        <button onclick="window.app.setTab('steps')" id="mob-steps" class="flex-1 py-1 text-slate-400 flex flex-col items-center gap-1"><span class="text-xl">üéì</span><span class="text-[9px] font-bold">Aula</span></button>
        <button onclick="window.app.setTab('bom')" id="mob-bom" class="flex-1 py-1 text-slate-400 flex flex-col items-center gap-1"><span class="text-xl">üí∞</span><span class="text-[9px] font-bold">Or√ßa.</span></button>
    </div>

    <!-- MODAL -->
    <div id="generic-modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-5 max-h-[90vh] overflow-y-auto">
            <h3 id="g-modal-title" class="text-lg font-bold text-slate-800 mb-2 fun-font"></h3>
            <div id="g-modal-content"></div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="window.app.closeModal()" class="px-4 py-2 text-slate-500 font-bold text-xs rounded-lg hover:bg-slate-50">Cancelar</button>
                <button id="g-modal-confirm" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold text-xs shadow">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig); 
        const AUTH = getAuth(app); 
        const db = getFirestore(app);

        const USER_IMAGES = [
            "https://i.postimg.cc/3JkY1Wrk/Img8.jpg", 
            "https://i.postimg.cc/MG7WB46d/Img6.jpg", 
            "https://i.postimg.cc/nrzZ6hvk/Img7.jpg", 
            "https://i.postimg.cc/dtftcrN1/Img5.jpg", 
            "https://i.postimg.cc/sXJDkLbv/Img4.jpg", 
            "https://i.postimg.cc/zfKfjvjn/Img3.jpg", 
            "https://i.postimg.cc/nhsrX09P/Img2.jpg", 
            "https://i.postimg.cc/L5N51WVt/Img1.jpg", 
            "https://i.postimg.cc/FKkY6myd/Screenshot-20251126-174442-M365-Copilot.jpg",
            "https://i.postimg.cc/SK9Krdqb/Screenshot-20251126-174305-M365-Copilot.jpg",
            "https://i.postimg.cc/0yTkbSSw/Screenshot-20251126-173528-M365-Copilot.jpg"
        ];

        const JP_PRICES = {
            breaker_1: 18.90, breaker_3: 95.00, idr: 220.00, outlet: 24.50,
            light_point: 15.00, switch: 12.50,
            cable_15: 1.85, cable_25: 2.95, cable_40: 6.20, cable_60: 9.80
        };

        const defaultData = {
            settings: { globalPF: 0.92 },
            prices: JSON.parse(JSON.stringify(JP_PRICES)),
            rooms: [
                { id: 99, name: "Garagem", floor: "subsolo", type: "living", area: 30, items: [
                    { id: 9901, type: 'light', name: 'Luz Teto', va: 100, pf: 1.0, circuitId: 1 },
                    { id: 9902, type: 'outlet', name: 'TUG', va: 100, pf: 0.92, circuitId: 2 }
                ]},
                { id: 5, name: "Escrit√≥rio", floor: "superior", type: "living", area: 10, items: [
                    { id: 5001, type: 'light', name: 'Luz Centro', va: 160, pf: 1.0, circuitId: 101 },
                    { id: 5002, type: 'outlet', name: 'Computador', va: 200, pf: 0.92, circuitId: 102 },
                    { id: 5003, type: 'equipment', name: 'Ar Split 9000', va: 1200, pf: 0.92, circuitId: 401 }
                ]},
                { id: 1, name: "Sala Estar", floor: "terreo", type: "living", area: 20, items: [
                    { id: 101, type: 'light', name: 'Lustre Central', va: 160, pf: 1.0, circuitId: 1 },
                    { id: 102, type: 'outlet', name: 'TV', va: 100, pf: 0.92, circuitId: 2 },
                    { id: 103, type: 'outlet', name: 'Geral', va: 100, pf: 0.92, circuitId: 2 },
                    { id: 104, type: 'outlet', name: 'Geral', va: 100, pf: 0.92, circuitId: 2 }
                ]},
                { id: 2, name: "Cozinha", floor: "terreo", type: "kitchen", area: 12, items: [
                    { id: 201, type: 'light', name: 'Luz Teto', va: 160, pf: 1.0, circuitId: 1 },
                    { id: 202, type: 'outlet', name: 'Geladeira', va: 600, pf: 0.92, circuitId: 2 },
                    { id: 203, type: 'outlet', name: 'Bancada 1', va: 600, pf: 0.92, circuitId: 2 },
                    { id: 204, type: 'outlet', name: 'Bancada 2', va: 600, pf: 0.92, circuitId: 2 },
                    { id: 3001, type: 'equipment', name: 'Forno El√©trico', va: 3000, pf: 1.0, circuitId: 504 },
                    { id: 3002, type: 'equipment', name: 'Lava Lou√ßas', va: 1543, pf: 1.0, circuitId: 501 },
                    { id: 3003, type: 'equipment', name: 'Cooktop', va: 7000, pf: 1.0, circuitId: 502 }
                ]},
                { id: 3, name: "Banheiro Social", floor: "terreo", type: "bathroom", area: 4, items: [
                    { id: 301, type: 'light', name: 'Luz', va: 100, pf: 1.0, circuitId: 1 },
                    { id: 302, type: 'outlet', name: 'Secador', va: 600, pf: 0.92, circuitId: 2 },
                    { id: 4001, type: 'equipment', name: 'Chuveiro 6800W', va: 6800, pf: 1.0, circuitId: 301 }
                ]},
                 { id: 4, name: "√Årea Servi√ßo", floor: "terreo", type: "kitchen", area: 6, items: [
                    { id: 401, type: 'light', name: 'Luz', va: 100, pf: 1.0, circuitId: 1 },
                    { id: 402, type: 'outlet', name: 'Ferro', va: 600, pf: 0.92, circuitId: 2 },
                    { id: 4002, type: 'equipment', name: 'Lava Roupas 15kg', va: 2280, pf: 1.0, circuitId: 503 }
                ]},
                { id: 9, name: "Su√≠te Master", floor: "superior", type: "living", area: 16, items: [
                    { id: 901, type: 'equipment', name: 'Ar Cond. 12000', va: 1300, pf: 0.92, circuitId: 402 },
                    { id: 902, type: 'light', name: 'Luz Quarto', va: 160, pf: 1.0, circuitId: 101 },
                    { id: 905, type: 'outlet', name: 'Cabeceira', va: 100, pf: 0.92, circuitId: 102 }
                ]},
                { id: 10, name: "Quarto 1", floor: "superior", type: "living", area: 12, items: [
                    { id: 1001, type: 'equipment', name: 'Ar Split 9000', va: 1200, pf: 0.92, circuitId: 403 },
                    { id: 1002, type: 'light', name: 'Luz Quarto', va: 100, pf: 1.0, circuitId: 101 },
                    { id: 1003, type: 'outlet', name: 'TUG', va: 100, pf: 0.92, circuitId: 102 }
                ]},
                { id: 12, name: "Quarto 2", floor: "superior", type: "living", area: 12, items: [
                    { id: 1201, type: 'equipment', name: 'Ar Split 9000', va: 1200, pf: 0.92, circuitId: 404 },
                    { id: 1202, type: 'light', name: 'Luz Quarto', va: 100, pf: 1.0, circuitId: 101 },
                    { id: 1203, type: 'outlet', name: 'TUG', va: 100, pf: 0.92, circuitId: 102 }
                ]},
                { id: 13, name: "Quarto 3", floor: "superior", type: "living", area: 12, items: [
                    { id: 1301, type: 'equipment', name: 'Ar Split 9000', va: 1200, pf: 0.92, circuitId: 405 },
                    { id: 1302, type: 'light', name: 'Luz Quarto', va: 100, pf: 1.0, circuitId: 101 },
                    { id: 1303, type: 'outlet', name: 'TUG', va: 100, pf: 0.92, circuitId: 102 }
                ]},
                { id: 11, name: "WCB Su√≠te", floor: "superior", type: "bathroom", area: 5, items: [
                    { id: 1101, type: 'equipment', name: 'Chuveiro 7500W', va: 7500, pf: 1.0, circuitId: 302 },
                    { id: 1102, type: 'light', name: 'Luz', va: 100, pf: 1.0, circuitId: 101 },
                    { id: 1103, type: 'outlet', name: 'Bancada', va: 600, pf: 0.92, circuitId: 102 }
                ]},
                { id: 15, name: "WCB Social Sup.", floor: "superior", type: "bathroom", area: 4, items: [
                    { id: 1501, type: 'equipment', name: 'Chuveiro 6800W', va: 6800, pf: 1.0, circuitId: 303 },
                    { id: 1502, type: 'light', name: 'Luz', va: 100, pf: 1.0, circuitId: 101 },
                    { id: 1503, type: 'outlet', name: 'Secador', va: 600, pf: 0.92, circuitId: 102 }
                ]}
            ],
            circuits: [
                { id: 1, name: "Ilum. T√©rreo", qd: "terreo", phase: "r", gauge: "1.5", usage: "lighting", dist: 20, pf: 1.0 },
                { id: 2, name: "TUGs T√©rreo", qd: "terreo", phase: "s", gauge: "2.5", usage: "power", dist: 15, pf: 0.92 },
                { id: 101, name: "Ilum. Superior", qd: "superior", phase: "t", gauge: "1.5", usage: "lighting", dist: 20, pf: 1.0 },
                { id: 102, name: "TUGs Superior", qd: "superior", phase: "r", gauge: "2.5", usage: "power", dist: 15, pf: 0.92 },
                { id: 301, name: "Chuv. Social Ter.", qd: "terreo", phase: "t", gauge: "6.0", usage: "specific", dist: 15, pf: 1.0, customAmp: 40 },
                { id: 302, name: "Chuv. Su√≠te", qd: "superior", phase: "r", gauge: "6.0", usage: "specific", dist: 10, pf: 1.0, customAmp: 40 },
                { id: 303, name: "Chuv. Social Sup.", qd: "superior", phase: "s", gauge: "6.0", usage: "specific", dist: 12, pf: 1.0, customAmp: 40 },
                { id: 401, name: "AC Escrit√≥rio", qd: "terreo", phase: "r", gauge: "2.5", usage: "specific", dist: 10, pf: 0.92 },
                { id: 402, name: "AC Su√≠te", qd: "superior", phase: "t", gauge: "2.5", usage: "specific", dist: 10, pf: 0.92 },
                { id: 403, name: "AC Quarto 1", qd: "superior", phase: "s", gauge: "2.5", usage: "specific", dist: 12, pf: 0.92 },
                { id: 404, name: "AC Quarto 2", qd: "superior", phase: "t", gauge: "2.5", usage: "specific", dist: 14, pf: 0.92 },
                { id: 405, name: "AC Quarto 3", qd: "superior", phase: "r", gauge: "2.5", usage: "specific", dist: 16, pf: 0.92 },
                { id: 501, name: "Lava-Lou√ßas", qd: "terreo", phase: "s", gauge: "2.5", usage: "specific", dist: 15, pf: 1.0 },
                { id: 502, name: "Cooktop", qd: "terreo", phase: "t", gauge: "6.0", usage: "specific", dist: 15, pf: 1.0, customAmp: 40 },
                { id: 503, name: "Lava-Roupas", qd: "terreo", phase: "r", gauge: "2.5", usage: "specific", dist: 18, pf: 1.0 },
                { id: 504, name: "Forno", qd: "terreo", phase: "r", gauge: "2.5", usage: "specific", dist: 15, pf: 1.0 }
            ]
        };

        let Project = JSON.parse(JSON.stringify(defaultData));
        let DB_REF = null;
        let currentFloorFilter = 'all';
        let CALCULATED_DATA = null;

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(AUTH, __initial_auth_token);
                } else {
                    await signInAnonymously(AUTH);
                }
            } catch (error) {
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('btn-enter').classList.remove('hidden');
            }
        };
        initAuth();

        onAuthStateChanged(AUTH, u => {
            if(u) {
                document.getElementById('auth-screen').classList.add('hidden'); 
                document.getElementById('app-interface').classList.remove('hidden'); 
                document.getElementById('app-interface').classList.add('flex'); 
                document.getElementById('mobile-menu').classList.remove('hidden'); 
                document.getElementById('mobile-menu').classList.add('flex');
                
                DB_REF = doc(db, 'artifacts', appId, 'users', u.uid, 'data', 'project_data');
                
                onSnapshot(DB_REF, (s) => { 
                    if(s.exists()) { 
                        const remoteData = s.data();
                        if(!remoteData.prices) remoteData.prices = JSON.parse(JSON.stringify(JP_PRICES));
                        Project = remoteData;
                        renderAll(); 
                    } else { 
                        Project = JSON.parse(JSON.stringify(defaultData)); 
                        setDoc(DB_REF, Project); 
                        renderAll();
                    }
                });
            } else { 
                document.getElementById('auth-screen').classList.remove('hidden'); 
            }
        });

        function saveCloud() { 
            if(DB_REF) {
                setDoc(DB_REF, Project).then(() => {
                    showToast();
                }).catch(console.error);
            }
            renderAll(); 
        }

        function showToast() {
            const t = document.getElementById("toast");
            t.className = "show";
            setTimeout(() => { t.className = t.className.replace("show", ""); }, 2000);
        }
        
        function renderAll() { 
            CALCULATED_DATA = calculateDemand(); 
            renderRooms(); 
            renderCircuits(); 
            renderDidacticMemory(); 
            renderBOM(); 
        }

        function calculateServiceEntrance(amps) {
            let breaker = 0;
            let cable = 0;

            if (amps <= 40) { breaker = 40; cable = 10; }
            else if (amps <= 50) { breaker = 50; cable = 10; } 
            else if (amps <= 63) { breaker = 63; cable = 16; }
            else if (amps <= 80) { breaker = 80; cable = 25; }
            else if (amps <= 100) { breaker = 100; cable = 35; }
            else if (amps <= 125) { breaker = 125; cable = 50; }
            else { breaker = 150; cable = 70; } 

            return { breaker, cable };
        }

        function getIconForType(type, name) {
            const n = name.toLowerCase();
            if (type === 'light') return 'üí°';
            if (type === 'outlet') return 'üîå';
            
            if (n.includes('chuveiro')) return 'üöø';
            if (n.includes('ar') && (n.includes('cond') || n.includes('split'))) return '‚ùÑÔ∏è';
            if (n.includes('forno') || n.includes('fog√£o') || n.includes('cooktop')) return 'üç≥';
            if (n.includes('lava') || n.includes('roupa') || n.includes('secadora')) return 'üß∫';
            if (n.includes('lou√ßa')) return 'üçΩÔ∏è';
            if (n.includes('geladeira') || n.includes('freezer')) return 'üßä';
            if (n.includes('tv') || n.includes('televis√£o')) return 'üì∫';
            if (n.includes('micro')) return 'üç≤';
            if (n.includes('computador') || n.includes('pc')) return 'üíª';
            
            return 'üîå'; 
        }

        function calculateDemand() {
            let loads = { d1_light:0, d1_tug:0, d2_shower:{w:0, c:0}, d3_wash:{w:0, c:0}, d4_cook:{w:0, c:0}, d5_ac:{w:0, c:0}, d_other:0 };
            let loadsByPhase = { r:0, s:0, t:0 };
            
            Project.rooms.forEach(r => {
                r.items.forEach(i => {
                    const circ = Project.circuits.find(c => c.id == i.circuitId);
                    const watts = i.va * (i.pf || 0.92);
                    if(circ) loadsByPhase[circ.phase] += watts;

                    if (i.type === 'light') loads.d1_light += watts;
                    else if (i.type === 'outlet') loads.d1_tug += watts;
                    else if (i.name.toLowerCase().includes('chuveiro')) { loads.d2_shower.w += watts; loads.d2_shower.c++; }
                    else if (i.name.toLowerCase().includes('lava') || i.name.toLowerCase().includes('micro')) { loads.d3_wash.w += watts; loads.d3_wash.c++; }
                    else if (i.name.toLowerCase().includes('forno') || i.name.toLowerCase().includes('fog√£o') || i.name.toLowerCase().includes('cooktop')) { loads.d4_cook.w += watts; loads.d4_cook.c++; }
                    else if (i.name.toLowerCase().includes('ar')) { loads.d5_ac.w += watts; loads.d5_ac.c++; }
                    else loads.d_other += watts;
                });
            });

            const d1_tot = (loads.d1_light + loads.d1_tug + loads.d_other) / 1000;
            let fd1 = 0.86;
            if(d1_tot > 1) fd1 = 0.75; if(d1_tot > 2) fd1 = 0.66; if(d1_tot > 3) fd1 = 0.59; if(d1_tot > 4) fd1 = 0.52;
            if(d1_tot > 5) fd1 = 0.45; if(d1_tot > 6) fd1 = 0.40; if(d1_tot > 7) fd1 = 0.35; if(d1_tot > 8) fd1 = 0.31;
            if(d1_tot > 9) fd1 = 0.27; if(d1_tot > 10) fd1 = 0.24;

            let fd2 = 1.0; if(loads.d2_shower.c==2) fd2=0.75; else if(loads.d2_shower.c==3) fd2=0.70; else if(loads.d2_shower.c>=4) fd2=0.66;
            let fd3 = 1.0; if(loads.d3_wash.c>=2 && loads.d3_wash.c<=4) fd3=0.70;
            let fd4 = 1.0; if(loads.d4_cook.c==2) fd4=0.60; if(loads.d4_cook.c==3) fd4=0.48;
            let fd5 = 1.0; if(loads.d5_ac.c>=2) fd5=0.88;

            const totalDemandaKW = (d1_tot * fd1) + ((loads.d2_shower.w/1000) * fd2) + ((loads.d3_wash.w/1000) * fd3) + ((loads.d4_cook.w/1000) * fd4) + ((loads.d5_ac.w/1000) * fd5);
            const totalDemandaKVA = totalDemandaKW / 0.92;
            const amps = (totalDemandaKW * 1000) / (1.732 * 380 * 0.92);

            const entrance = calculateServiceEntrance(amps);

            return { loads, loadsByPhase, factors: { fd1, fd2, fd3, fd4, fd5 }, totalDemandaKW, totalDemandaKVA, amps, entrance };
        }

        function renderRooms() {
            const grid = document.getElementById('rooms-grid'); grid.innerHTML = '';
            const filtered = currentFloorFilter === 'all' ? Project.rooms : Project.rooms.filter(r => r.floor === currentFloorFilter);
            filtered.forEach(r => {
                const itemsHtml = r.items.map(i => {
                     const circ = Project.circuits.find(c => c.id == i.circuitId);
                     const cBadge = circ ? `<span class="text-[9px] font-bold px-1 rounded ml-1 border ${circ.phase=='r'?'text-red-600 border-red-200 bg-red-50':(circ.phase=='s'?'text-slate-800 border-slate-300 bg-slate-50':'text-yellow-600 border-yellow-200 bg-yellow-50')}">C${Project.circuits.indexOf(circ)+1}</span>` : '<span class="text-[9px] text-red-500 font-bold ml-1">üö´</span>';
                     const icon = getIconForType(i.type, i.name);
                     return `<div class="flex justify-between items-center py-1.5 border-b border-slate-50 last:border-0"><div class="flex items-center gap-1 text-sm text-slate-700"><span>${icon}</span><span>${i.name}</span>${cBadge}<span class="text-[9px] text-slate-400 font-mono ml-1">${i.va}VA</span></div><div class="flex gap-1"><button onclick="window.app.editItem(${r.id},${i.id})" class="text-[10px] text-blue-400">‚úèÔ∏è</button><button onclick="window.app.delItem(${r.id},${i.id})" class="text-[10px] text-red-300 hover:text-red-500">‚úï</button></div></div>`;
                }).join('');
                
                grid.innerHTML += `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 card-hover">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-[9px] uppercase font-bold tracking-wider bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">${r.floor}</span>
                            <div class="flex items-center gap-2">
                                <h3 class="font-bold text-slate-800">${r.name}</h3>
                                <button onclick="window.app.editRoom(${r.id})" class="text-[10px] text-blue-500 hover:underline">‚úèÔ∏è</button>
                                <button onclick="window.app.delRoom(${r.id})" class="text-[12px] text-red-300 hover:text-red-600 ml-2" title="Excluir C√¥modo">üóëÔ∏è</button>
                            </div>
                            <p class="text-[10px] text-slate-400">A: <b>${r.area||0}m¬≤</b></p>
                        </div>
                        <button onclick="window.app.modalAddItem(${r.id})" class="w-6 h-6 rounded bg-indigo-50 text-indigo-600 font-bold hover:bg-indigo-100 flex items-center justify-center">+</button>
                    </div>
                    <div class="space-y-1">${itemsHtml || '<p class="text-xs text-slate-300 italic py-2">Vazio</p>'}</div>
                </div>`;
            });
        }

        function renderCircuits() {
            const c = CALCULATED_DATA;
            const setLoad = (ph, w) => {
                 document.getElementById(`load-${ph}-w`).innerText = Math.round(w) + ' W';
                 document.getElementById(`load-${ph}-a`).innerText = (w/220).toFixed(1) + ' A';
            };
            setLoad('r', c.loadsByPhase.r); setLoad('s', c.loadsByPhase.s); setLoad('t', c.loadsByPhase.t);

            const qdT = document.getElementById('list-qd-terreo'); const qdS = document.getElementById('list-qd-superior'); qdT.innerHTML = ''; qdS.innerHTML = '';
            Project.circuits.forEach((circ, idx) => {
                let circVa = 0; Project.rooms.forEach(r => r.items.forEach(i => { if(i.circuitId == circ.id) circVa += (i.va || 0); }));
                const html = `
                <div class="flex justify-between items-center p-2 bg-white rounded border border-slate-100 shadow-sm text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded flex items-center justify-center text-[10px] font-bold text-white uppercase ${circ.phase==='r'?'bg-phase-r':circ.phase==='s'?'bg-phase-s':'bg-phase-t'}">C${idx+1}</div>
                        <div><p class="font-bold text-slate-700 leading-none">${circ.name}</p><p class="text-[10px] text-slate-400 font-mono">${circVa}VA ‚Ä¢ ${circ.gauge}mm¬≤</p></div>
                    </div>
                    <button onclick="window.app.delCirc(${circ.id})" class="text-slate-300 hover:text-red-500">‚úï</button>
                </div>`;
                if(circ.qd === 'terreo') qdT.innerHTML += html; else qdS.innerHTML += html;
            });
        }

        function getRoomCalculationHTML(room) {
            let lightTxt = "";
            let area = room.area;
            if (area <= 6) {
                lightTxt = `√Årea ${area}m¬≤ ‚â§ 6m¬≤ ‚Üí <span class="calc-highlight">100 VA</span> (M√≠nimo).`;
            } else {
                let whole4 = Math.floor((area - 6) / 4);
                let lightVA = 100 + (whole4 * 60);
                lightTxt = `√Årea ${area}m¬≤ > 6m¬≤ (100VA + ${whole4}x60VA) = <span class="calc-highlight">${lightVA} VA</span>.`;
            }

            let tugTxt = "";
            let p = Math.sqrt(area) * 4; 
            let pStr = p.toFixed(1);

            if (room.type === 'bathroom') {
                tugTxt = `Banheiro: <span class="calc-highlight">1 x 600 VA</span> (lavat√≥rio).`;
            } else if (room.type === 'kitchen') {
                let qtd = Math.ceil(p / 3.5);
                tugTxt = `Cozinha (~${pStr}m): ${qtd} tomadas (3x <span class="calc-highlight">600VA</span>).`;
            } else {
                if (area < 6) tugTxt = `√Årea < 6m¬≤: 1x <span class="calc-highlight">100 VA</span>.`;
                else {
                    let qtd = Math.ceil(p / 5);
                    tugTxt = `Sala/Quarto (~${pStr}m): ${qtd}x <span class="calc-highlight">100 VA</span>.`;
                }
            }

            return `
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-slate-800">${room.name}</h4>
                        <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded font-bold uppercase text-slate-500">${room.area}m¬≤</span>
                    </div>
                    <div class="text-xs text-slate-500 mb-1">üí° <b class="text-slate-700">Ilumina√ß√£o:</b></div>
                    <div class="calc-box mb-3">${lightTxt}</div>
                    <div class="text-xs text-slate-500 mb-1">üîå <b class="text-slate-700">Tomadas:</b></div>
                    <div class="calc-box">${tugTxt}</div>
                </div>
            `;
        }

        function renderDidacticMemory() {
            const container = document.getElementById('calc-steps-content');
            const roomContainer = document.getElementById('room-calc-container');
            
            if(!CALCULATED_DATA) return;
            const c = CALCULATED_DATA;

            document.getElementById('img-formula').src = USER_IMAGES[0];
            document.getElementById('img-didatico-luz').src = USER_IMAGES[9];
            document.getElementById('img-didatico-tug').src = USER_IMAGES[8];
            document.getElementById('img-tab4-1').src = USER_IMAGES[1];
            document.getElementById('img-tab4-2').src = USER_IMAGES[2];

            roomContainer.innerHTML = '';
            Project.rooms.forEach(room => { roomContainer.innerHTML += getRoomCalculationHTML(room); });

            const createCard = (title, code, itemsCount, installedW, factor, imgUrl) => `
                <div class="bg-white rounded-xl shadow-md overflow-hidden border border-slate-200 flex flex-col md:flex-row">
                    <div class="flex-1 p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="bg-indigo-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">${code}</span>
                            <h3 class="text-lg font-bold text-slate-800">${title}</h3>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg mb-4 space-y-2">
                            <div class="flex justify-between text-sm"><span class="text-slate-500">Qtd:</span><span class="font-bold">${itemsCount}</span></div>
                            <div class="flex justify-between text-sm"><span class="text-slate-500">Instalada:</span><span class="font-bold text-slate-800">${(installedW/1000).toFixed(2)} kW</span></div>
                            <div class="flex justify-between text-sm items-center"><span class="text-slate-500">Fator:</span><span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded font-bold">${factor}</span></div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-slate-400 uppercase font-bold">Demanda Parcial</p>
                            <p class="text-2xl font-bold text-indigo-700">${(installedW/1000 * factor).toFixed(2)} kW</p>
                        </div>
                    </div>
                    <div class="bg-slate-100 p-4 md:w-64 flex flex-col justify-center items-center border-l border-slate-200">
                        <p class="text-[10px] uppercase text-slate-400 font-bold mb-2">Refer√™ncia</p>
                        <img src="${imgUrl}" class="norm-img" alt="Tabela" onclick="window.open(this.src, '_blank')">
                    </div>
                </div>`;

            const d1W = c.loads.d1_light + c.loads.d1_tug + c.loads.d_other;
            const htmlD1 = createCard("Ilumina√ß√£o e TUGs", "d1", "V√°rios", d1W, c.factors.fd1, USER_IMAGES[3]);
            const htmlD2 = createCard("Aquecimento", "d2", c.loads.d2_shower.c + " un", c.loads.d2_shower.w, c.factors.fd2, USER_IMAGES[4]);
            const htmlD3 = createCard("Servi√ßo", "d3", c.loads.d3_wash.c + " un", c.loads.d3_wash.w, c.factors.fd3, USER_IMAGES[5]);
            const htmlD4 = createCard("Cozinha", "d4", c.loads.d4_cook.c + " un", c.loads.d4_cook.w, c.factors.fd4, USER_IMAGES[6]);
            const htmlD5 = createCard("Ar Condicionado", "d5", c.loads.d5_ac.c + " un", c.loads.d5_ac.w, c.factors.fd5, USER_IMAGES[7]);

            const currentCalcHTML = `
            <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6 mb-8">
                <h3 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">C√°lculo da Corrente e Disjuntor Geral</h3>
                <div class="text-sm text-slate-600 mb-4">
                    Para dimensionar o disjuntor geral, calculamos a corrente nominal ($I$) baseada na Demanda Total ($S$) em kVA e na tens√£o de linha ($V_{linha}$) de 380V (trif√°sico padr√£o JP).
                </div>
                <div class="text-center bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <div class="math-display">$$I = \\frac{S_{total} \\times 1000}{\\sqrt{3} \\times V_{linha}}$$</div>
                    <div class="math-display">$$I = \\frac{${c.totalDemandaKVA.toFixed(2)} \\times 1000}{1.732 \\times 380}$$</div>
                    <div class="math-display">$$I \\approx ${c.amps.toFixed(2)} \\text{ A}$$</div>
                </div>
                <div class="mt-4 text-sm text-slate-500">
                    <p>O disjuntor comercial escolhido deve ser o valor imediatamente superior √† corrente calculada (${c.amps.toFixed(1)} A). Neste caso: <b>${c.entrance.breaker} A</b>.</p>
                </div>
            </div>`;

            const resultHTML = `
                <div class="bg-slate-900 text-white rounded-2xl p-8 shadow-2xl flex flex-col md:flex-row items-center justify-between gap-8 mb-8">
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold text-yellow-400 fun-font mb-2">Resultado</h3>
                        <p class="text-slate-300 text-sm mb-6">Demanda total (kW) convertida para kVA.</p>
                        <div class="space-y-2 font-mono text-sm text-slate-400">
                            <p>d(kW) = ${(c.totalDemandaKW).toFixed(2)} kW</p>
                            <p>D(kVA) = ${c.totalDemandaKVA.toFixed(2)} / 0,92</p>
                        </div>
                    </div>
                    <div class="bg-white/10 p-6 rounded-xl text-center backdrop-blur-sm border border-white/20">
                        <p class="text-xs uppercase font-bold text-slate-300 mb-1">Demanda Total</p>
                        <p class="text-4xl font-black text-white">${c.totalDemandaKVA.toFixed(2)} kVA</p>
                        <p class="text-xs text-green-400 mt-2 font-bold">~${c.amps.toFixed(1)} A</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Dimensionamento Ramal de Entrada</h3>
                    <div class="flex flex-col md:flex-row gap-6 items-center">
                        <div class="flex-1 space-y-4">
                            <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                                <p class="text-xs text-slate-500 uppercase font-bold mb-1">Disjuntor Geral Recomendado</p>
                                <p class="text-2xl font-black text-indigo-700">${c.entrance.breaker} A <span class="text-sm font-normal text-slate-500">(Tripolar)</span></p>
                            </div>
                            <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                                <p class="text-xs text-slate-500 uppercase font-bold mb-1">Cabo de Entrada (Fase)</p>
                                <p class="text-2xl font-black text-indigo-700">${c.entrance.cable} mm¬≤</p>
                            </div>
                        </div>
                        <div class="md:w-1/2 text-center">
                            <img src="${USER_IMAGES[10]}" class="norm-img h-48 w-full object-contain bg-slate-50" onclick="window.open(this.src, '_blank')">
                            <p class="text-[10px] text-slate-400 mt-2">Baseado na tabela da concession√°ria local</p>
                        </div>
                    </div>
                </div>`;

            container.innerHTML = htmlD1 + htmlD2 + htmlD3 + htmlD4 + htmlD5 + currentCalcHTML + resultHTML;
            
            if(window.MathJax) {
                window.MathJax.typesetPromise();
            }
        }

        function renderBOM() {
             const tbody = document.getElementById('bom-table-body'); tbody.innerHTML = '';
             const prices = Project.prices || JP_PRICES;
             const c = CALCULATED_DATA;
             
             let items = { 
                 breaker_1: Project.circuits.filter(c => c.phase.length === 1).length || 0, 
                 breaker_3: 1, 
                 idr: 1,
                 outlet: 0, 
                 light_point: 0,
                 switch: 0,
                 cable_15: 0, cable_25: 0, cable_40: 0, cable_60: 0
             };

             Project.rooms.forEach(r => {
                 r.items.forEach(i => {
                     if(i.type==='outlet' || i.type==='equipment') items.outlet++;
                     if(i.type==='light') { items.light_point++; items.switch++; }
                 });
             });

             Project.circuits.forEach(c => {
                 const len = (c.dist || 15) * 2.5;
                 if(c.gauge == '1.5') items.cable_15 += len;
                 else if(c.gauge == '2.5') items.cable_25 += len;
                 else if(c.gauge == '4.0') items.cable_40 += len;
                 else items.cable_60 += len;
             });

             let totalCost = 0;

             const addRow = (key, name, qty, isCable) => {
                 if(qty <= 0) return;
                 const p = prices[key] || 0;
                 const t = qty * p;
                 totalCost += t;
                 tbody.innerHTML += `
                    <tr class="hover:bg-slate-50">
                        <td class="p-3 font-medium text-slate-700 text-xs whitespace-nowrap">${name}</td>
                        <td class="p-3 text-center text-slate-500 text-xs">${Math.ceil(qty)} ${isCable?'m':'un'}</td>
                        <td class="p-3 text-right"><input type="number" step="0.10" class="price-input" value="${p.toFixed(2)}" onchange="window.app.updatePrice('${key}', this.value)"></td>
                        <td class="p-3 text-right font-bold text-slate-700 text-xs">R$ ${t.toFixed(2)}</td>
                    </tr>`;
             };

             const entranceCableQty = 15 * 4; 
             const entranceCablePrice = c.entrance.cable > 10 ? 15.00 : 8.00; 

             addRow('breaker_1', 'Disjuntor Monopolar (DIN)', items.breaker_1);
             addRow('breaker_3', `Disjuntor Geral Tripolar ${c.entrance.breaker}A`, items.breaker_3);
             addRow('idr', 'IDR Tetrapolar', items.idr);
             addRow('outlet', 'Tomadas (Conjunto 4x2)', items.outlet);
             addRow('light_point', 'Ponto de Luz (Octogonal+Bocal)', items.light_point);
             addRow('switch', 'Interruptor Simples', items.switch);
             addRow('cable_15', 'Cabo Flex 1.5mm¬≤', items.cable_15, true);
             addRow('cable_25', 'Cabo Flex 2.5mm¬≤', items.cable_25, true);
             addRow('cable_40', 'Cabo Flex 4.0mm¬≤', items.cable_40, true);
             addRow('cable_60', 'Cabo Flex 6.0mm¬≤', items.cable_60, true);
             
             tbody.innerHTML += `
                <tr class="hover:bg-slate-50 bg-indigo-50/30">
                    <td class="p-3 font-medium text-indigo-800 text-xs whitespace-nowrap">Cabo Entrada ${c.entrance.cable}mm¬≤ (Est.)</td>
                    <td class="p-3 text-center text-slate-500 text-xs">${entranceCableQty} m</td>
                    <td class="p-3 text-right"><input type="number" step="0.10" class="price-input" value="${entranceCablePrice.toFixed(2)}" disabled></td>
                    <td class="p-3 text-right font-bold text-slate-700 text-xs">R$ ${(entranceCableQty * entranceCablePrice).toFixed(2)}</td>
                </tr>`;
             totalCost += (entranceCableQty * entranceCablePrice);

             document.getElementById('bom-total-price').innerText = 'R$ ' + totalCost.toFixed(2);
        }

        window.app = {
            closeModal: () => document.getElementById('generic-modal').classList.add('hidden'),
            updatePrice: (key, val) => {
                if(!Project.prices) Project.prices = {};
                Project.prices[key] = parseFloat(val);
                saveCloud();
            },
            editRoom: (rid) => {
                const r = Project.rooms.find(x => x.id === rid);
                const el = document.getElementById('generic-modal'); document.getElementById('g-modal-title').innerText = "Editar C√¥modo";
                document.getElementById('g-modal-content').innerHTML = `
                    <div class="space-y-3">
                        <input id="er-name" class="w-full border p-2 rounded" value="${r.name}">
                        <label class="text-xs font-bold text-slate-500">√Årea (m¬≤)</label>
                        <input id="er-area" type="number" class="w-full border p-2 rounded" value="${r.area}">
                    </div>`;
                el.classList.remove('hidden'); el.classList.add('flex');
                document.getElementById('g-modal-confirm').onclick = () => { r.name=document.getElementById('er-name').value; r.area=Number(document.getElementById('er-area').value); saveCloud(); window.app.closeModal(); };
            },
            modalAddItem: (rid) => {
                const el = document.getElementById('generic-modal'); document.getElementById('g-modal-title').innerText = "Adicionar Item";
                const circs = Project.circuits.map(c => `<option value="${c.id}">C${Project.circuits.indexOf(c)+1} - ${c.name}</option>`).join('');
                document.getElementById('g-modal-content').innerHTML = `
                    <div class="space-y-3">
                        <select id="m-i-type" class="w-full border p-2 rounded bg-white"><option value="outlet">Tomada</option><option value="light">Luz</option><option value="equipment">Equipamento</option></select>
                        <input id="m-i-name" class="w-full border p-2 rounded" placeholder="Nome (ex: Ar Condicionado)">
                        <input id="m-i-va" type="number" class="w-full border p-2 rounded" placeholder="Pot√™ncia (VA/W)">
                        <select id="m-i-circ" class="w-full border p-2 rounded bg-white"><option value="">Sem Circuito</option>${circs}</select>
                    </div>`;
                el.classList.remove('hidden'); el.classList.add('flex');
                document.getElementById('g-modal-confirm').onclick = () => {
                    const r = Project.rooms.find(x => x.id === rid);
                    r.items.push({ id: Date.now(), type: document.getElementById('m-i-type').value, name: document.getElementById('m-i-name').value, va: Number(document.getElementById('m-i-va').value), circuitId: document.getElementById('m-i-circ').value });
                    saveCloud(); window.app.closeModal();
                };
            },
            editItem: (rid, iid) => {
                 const r = Project.rooms.find(x => x.id === rid); const i = r.items.find(x => x.id === iid);
                 const el = document.getElementById('generic-modal'); document.getElementById('g-modal-title').innerText = "Editar Item";
                 const circs = Project.circuits.map(c => `<option value="${c.id}" ${c.id==i.circuitId?'selected':''}>C${Project.circuits.indexOf(c)+1} - ${c.name}</option>`).join('');
                 document.getElementById('g-modal-content').innerHTML = `
                    <div class="space-y-3">
                        <input id="ei-name" class="w-full border p-2 rounded" value="${i.name}">
                        <input id="ei-va" type="number" class="w-full border p-2 rounded" value="${i.va}">
                        <select id="ei-circ" class="w-full border p-2 rounded bg-white"><option value="">Sem Circuito</option>${circs}</select>
                    </div>`;
                 el.classList.remove('hidden'); el.classList.add('flex');
                 document.getElementById('g-modal-confirm').onclick = () => { i.name=document.getElementById('ei-name').value; i.va=Number(document.getElementById('ei-va').value); i.circuitId=document.getElementById('ei-circ').value; saveCloud(); window.app.closeModal(); };
            },
            promptAddCircuit: () => {
                const el = document.getElementById('generic-modal'); document.getElementById('g-modal-title').innerText = "Novo Circuito";
                document.getElementById('g-modal-content').innerHTML = `<input id="c-name" class="w-full border p-2 rounded mb-2" placeholder="Nome"><div class="grid grid-cols-2 gap-2"><select id="c-ph" class="border p-2 rounded"><option value="r">R</option><option value="s">S</option><option value="t">T</option></select><select id="c-qd" class="border p-2 rounded"><option value="terreo">T√©rreo</option><option value="superior">Superior</option></select></div>`;
                el.classList.remove('hidden'); el.classList.add('flex');
                document.getElementById('g-modal-confirm').onclick = () => { Project.circuits.push({ id: Date.now(), name: document.getElementById('c-name').value, phase: document.getElementById('c-ph').value, qd: document.getElementById('c-qd').value, gauge: '2.5', dist: 15 }); saveCloud(); window.app.closeModal(); };
            },
            promptAddRoom: () => {
                 const el = document.getElementById('generic-modal'); document.getElementById('g-modal-title').innerText = "Novo C√¥modo";
                 document.getElementById('g-modal-content').innerHTML = `
                    <input id="nr-name" class="w-full border p-2 rounded mb-2" placeholder="Nome">
                    <input id="nr-area" type="number" class="border p-2 rounded w-full mb-2" placeholder="√Årea (m¬≤)">
                    <select id="nr-floor" class="w-full border p-2 rounded mb-2">
                        <option value="terreo">T√©rreo</option>
                        <option value="superior">Superior</option>
                        <option value="subsolo">Subsolo</option>
                    </select>
                    <select id="nr-type" class="w-full border p-2 rounded">
                        <option value="living">Sala/Quarto</option>
                        <option value="kitchen">Cozinha/Servi√ßo</option>
                        <option value="bathroom">Banheiro</option>
                    </select>`;
                 el.classList.remove('hidden'); el.classList.add('flex');
                 document.getElementById('g-modal-confirm').onclick = () => { 
                     const n = document.getElementById('nr-name').value; 
                     const a = Number(document.getElementById('nr-area').value); 
                     const t = document.getElementById('nr-type').value;
                     const f = document.getElementById('nr-floor').value;
                     if(n && a) { 
                        Project.rooms.push({ id: Date.now(), name: n, area: a, type: t, floor: f, items: [] }); 
                        saveCloud(); 
                        window.app.closeModal(); 
                     }
                 };
            },
            delRoom: (rid) => {
                const r = Project.rooms.find(x => x.id === rid);
                if(!r) return; 

                const el = document.getElementById('generic-modal'); 
                document.getElementById('g-modal-title').innerText = "Excluir C√¥modo";
                document.getElementById('g-modal-content').innerHTML = `
                    <div class="text-center p-4">
                        <p class="text-slate-700 mb-2">Tem certeza que deseja excluir <strong>${r.name}</strong>?</p>
                        <p class="text-xs text-red-500">Essa a√ß√£o n√£o pode ser desfeita.</p>
                    </div>`;
                
                const btn = document.getElementById('g-modal-confirm');
                const originalBtnClass = btn.className; 
                btn.className = "px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-xs shadow"; 
                btn.innerText = "Sim, Excluir";

                el.classList.remove('hidden'); 
                el.classList.add('flex');

                btn.onclick = () => { 
                    Project.rooms = Project.rooms.filter(x => x.id !== rid); 
                    saveCloud(); 
                    window.app.closeModal();
                    
                    btn.className = "px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold text-xs shadow";
                    btn.innerText = "Confirmar";
                };
            },
            delItem: (rid, iid) => { const r = Project.rooms.find(x => x.id === rid); if(r){ r.items = r.items.filter(i => i.id !== iid); saveCloud(); } },
            delCirc: (id) => { Project.circuits = Project.circuits.filter(x => x.id !== id); saveCloud(); },
            filterFloor: (f, btn) => { currentFloorFilter = f; document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderRooms(); },
            setTab: (id) => { 
                document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); 
                document.querySelectorAll('#nav-rooms, #nav-circuits, #nav-steps, #nav-bom').forEach(e => {
                    e.classList.remove('text-indigo-600', 'bg-white', 'shadow-sm');
                    e.classList.add('text-slate-500');
                });
                
                document.getElementById('tab-'+id).classList.add('active'); 
                const navBtn = document.getElementById('nav-'+id);
                if(navBtn) {
                    navBtn.classList.remove('text-slate-500');
                    navBtn.classList.add('text-indigo-600', 'bg-white', 'shadow-sm');
                }

                if(id==='steps') renderDidacticMemory(); 
            },
            handleAuthAction: async () => {
                document.getElementById('btn-enter').disabled = true;
                document.getElementById('btn-enter').innerHTML = 'Entrando...';
                document.getElementById('loading-indicator').classList.remove('hidden');
                try { 
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(AUTH, __initial_auth_token);
                    } else {
                        await signInAnonymously(AUTH); 
                    }
                } catch(err) { 
                    alert("Erro ao entrar: " + err.message); 
                    document.getElementById('btn-enter').disabled = false;
                    document.getElementById('btn-enter').innerHTML = 'ENTRAR MANUALMENTE';
                    document.getElementById('loading-indicator').classList.add('hidden');
                } 
            },
            handleLogout: () => location.reload()
        };
    </script>
</body>
</html>

