<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Projeto El√©trico - Walter & Elaine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        h1, h2, h3, .fun-font { font-family: 'Fredoka', sans-serif; }
        
        @media (min-width: 768px) { 
            body { height: 100vh; overflow: hidden; display: flex; flex-direction: column; } 
            .scroll-area { flex: 1; overflow-y: auto; padding-bottom: 40px; }
        }
        @media (max-width: 767px) {
            body { padding-bottom: 90px; min-height: 100vh; }
            .scroll-area { padding-bottom: 40px; }
        }
        
        .tab-content { display: none; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .tab-content.active { display: block; opacity: 1; }
        
        .card-hover { transition: all 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 16px -4px rgba(0,0,0,0.1); }

        .bg-phase-r { background-color: #ef4444; color: white; }
        .bg-phase-s { background-color: #1e293b; color: white; }
        .bg-phase-t { background-color: #facc15; color: black; }
        
        .auth-tab { cursor: pointer; padding-bottom: 8px; border-bottom: 3px solid transparent; color: #94a3b8; transition: all 0.2s; }
        .auth-tab.active { border-color: #6366f1; color: #6366f1; font-weight: 700; }

        .filter-btn { transition: all 0.2s; border: 1px solid #e2e8f0; }
        .filter-btn.active { background-color: #4338ca; color: white; border-color: #4338ca; }
        .filter-btn:not(.active) { background-color: white; color: #64748b; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body class="text-slate-800 bg-slate-50">

    <!-- ECR√É DE LOGIN -->
    <div id="auth-screen" class="fixed inset-0 bg-gradient-to-br from-slate-900 to-slate-800 z-50 overflow-y-auto">
        <div class="min-h-full flex items-center justify-center p-4 py-10">
            <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-8 relative">
                <div class="text-center mb-6">
                    <div class="bg-indigo-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl">‚ö°</div>
                    <h1 class="text-2xl font-bold text-slate-800 mb-1 fun-font">Projeto El√©trico</h1>
                    <p class="text-slate-500 text-xs font-medium">Walter & Elaine ‚Ä¢ NBR 5410</p>
                </div>
                <div class="flex justify-center gap-8 mb-6 border-b border-slate-100">
                    <div onclick="window.app.switchAuthMode('login')" id="tab-login" class="auth-tab active">Entrar</div>
                    <div onclick="window.app.switchAuthMode('register')" id="tab-register" class="auth-tab">Criar</div>
                </div>
                <div class="space-y-4">
                    <input id="auth-email" type="email" class="w-full border-2 border-slate-100 rounded-xl p-3 outline-none focus:border-indigo-500 text-sm transition-colors" placeholder="Email" autocomplete="email">
                    <input id="auth-pass" type="password" class="w-full border-2 border-slate-100 rounded-xl p-3 outline-none focus:border-indigo-500 text-sm transition-colors" placeholder="Senha" autocomplete="current-password">
                    <div id="auth-error" class="hidden bg-red-50 text-red-600 text-xs p-3 rounded-lg text-center font-bold border border-red-100"></div>
                    <button onclick="window.app.handleAuthAction()" id="btn-auth-action" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition text-sm active:scale-95">ACESSAR PROJETO</button>
                </div>
            </div>
        </div>
    </div>

    <!-- INTERFACE DA APLICA√á√ÉO -->
    <div id="app-interface" class="hidden flex-col h-full">
        <!-- CABE√áALHO -->
        <header class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm z-20 sticky top-0">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-md"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12H11l2-8z"/></svg></div>
                <div><h1 class="font-bold text-lg text-slate-800 leading-none fun-font">Dimensionamento</h1><p class="text-[10px] font-bold text-indigo-600 uppercase mt-0.5">C√°lculo de Demanda Customizado</p></div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="window.app.editSettings()" class="hidden md:flex bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold items-center gap-1 hover:bg-slate-200">‚öôÔ∏è Config</button>
                <div class="hidden md:flex bg-slate-100 p-1 rounded-lg gap-1">
                    <button onclick="window.app.setTab('rooms')" id="nav-rooms" class="px-3 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm">Planta</button>
                    <button onclick="window.app.setTab('circuits')" id="nav-circuits" class="px-3 py-1.5 rounded-md text-xs font-bold text-slate-500">C√°lculos</button>
                    <button onclick="window.app.setTab('bom')" id="nav-bom" class="px-3 py-1.5 rounded-md text-xs font-bold text-slate-500">Materiais</button>
                </div>
                <button onclick="window.app.handleLogout()" class="bg-red-50 text-red-500 p-2 rounded-lg hover:bg-red-100"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
            </div>
        </header>

        <!-- CONTE√öDO PRINCIPAL -->
        <main class="scroll-area p-4 md:p-6 max-w-6xl mx-auto w-full space-y-6">
            
            <!-- ABA 1: C√îMODOS -->
            <div id="tab-rooms" class="tab-content active">
                <div class="flex justify-between items-end mb-4">
                    <div><h2 class="text-xl font-bold text-slate-800 fun-font">C√¥modos</h2><p class="text-slate-500 text-xs">Gerencie os pontos de consumo.</p></div>
                    <button onclick="window.app.promptAddRoom()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold shadow-lg text-sm flex items-center gap-1 hover:bg-indigo-700 transition transform active:scale-95"><span>+</span> C√¥modo</button>
                </div>
                <div class="flex gap-2 mb-4 overflow-x-auto pb-1 snap-x">
                    <button onclick="window.app.filterFloor('all', this)" class="filter-btn active snap-start px-4 py-1.5 rounded-full text-xs font-bold">Todos</button>
                    <button onclick="window.app.filterFloor('subsolo', this)" class="filter-btn snap-start px-4 py-1.5 rounded-full text-xs font-bold">Subsolo</button>
                    <button onclick="window.app.filterFloor('terreo', this)" class="filter-btn snap-start px-4 py-1.5 rounded-full text-xs font-bold">T√©rreo</button>
                    <button onclick="window.app.filterFloor('superior', this)" class="filter-btn snap-start px-4 py-1.5 rounded-full text-xs font-bold">Superior</button>
                </div>
                <div id="rooms-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- ABA 2: C√ÅLCULOS -->
            <div id="tab-circuits" class="tab-content">
                
                <!-- PAINEL GERAL -->
                <div class="bg-slate-900 text-white p-5 rounded-2xl shadow-lg mb-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 opacity-10 text-[100px]">‚ö°</div>
                    <div class="flex justify-between items-start mb-4 relative z-10">
                        <div>
                            <h2 class="text-xl font-bold fun-font text-yellow-400">Prote√ß√£o Geral</h2>
                            <p class="text-slate-400 text-xs">Disjuntor e Cabos de Entrada (C√°lculo Demanda).</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.app.editSettings()" class="bg-slate-700 hover:bg-slate-600 text-white text-xs px-3 py-1.5 rounded-lg font-bold transition">‚öôÔ∏è Config</button>
                            <button onclick="window.app.editMainParams()" class="bg-slate-700 hover:bg-slate-600 text-white text-xs px-3 py-1.5 rounded-lg font-bold transition">üìè Dist√¢ncia</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 relative z-10">
                        <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                            <p class="text-[10px] text-slate-400 uppercase font-bold">Disjuntor Geral</p>
                            <p id="gen-breaker" class="text-2xl font-bold text-white">-- A</p>
                            <p id="gen-demand-factor" class="text-[9px] text-slate-500">Demanda: --%</p>
                        </div>
                        <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                            <p class="text-[10px] text-slate-400 uppercase font-bold">Cabo Entrada</p>
                            <p id="gen-cable" class="text-2xl font-bold text-green-400">-- mm¬≤</p>
                            <p id="gen-dist" class="text-[9px] text-slate-500">Dist: -- m</p>
                        </div>
                        <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                            <p class="text-[10px] text-slate-400 uppercase font-bold">Demanda Aparente</p>
                            <p id="gen-load-va-demand" class="text-xl font-bold text-blue-300">-- VA</p>
                             <p id="gen-load-va-total" class="text-[9px] text-slate-500">Total: -- VA</p>
                        </div>
                        <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                            <p class="text-[10px] text-slate-400 uppercase font-bold">Demanda Ativa (W)</p>
                            <p id="gen-load-w" class="text-xl font-bold text-yellow-400">-- W</p>
                            <p class="text-[9px] text-slate-500">Pot√™ncia de Demanda (d1..d5)</p>
                        </div>
                    </div>
                </div>

                <!-- EQUILIBRIO -->
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-slate-700 text-sm uppercase tracking-wide">Balanceamento (Carga Total Instalada)</h3>
                    <button onclick="window.app.promptAddCircuit()" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow hover:bg-indigo-700">+ Circuito</button>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-white p-3 rounded-xl border-b-4 border-red-500 shadow-sm text-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Fase R</span>
                        <div id="load-r-w" class="text-lg font-black text-red-600">0 W</div>
                        <div id="load-r-a" class="text-[10px] font-mono text-slate-500 mt-1">0.0 A</div>
                    </div>
                    <div class="bg-white p-3 rounded-xl border-b-4 border-slate-900 shadow-sm text-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Fase S</span>
                        <div id="load-s-w" class="text-lg font-black text-slate-900">0 W</div>
                        <div id="load-s-a" class="text-[10px] font-mono text-slate-500 mt-1">0.0 A</div>
                    </div>
                    <div class="bg-white p-3 rounded-xl border-b-4 border-yellow-400 shadow-sm text-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Fase T</span>
                        <div id="load-t-w" class="text-lg font-black text-yellow-600">0 W</div>
                        <div id="load-t-a" class="text-[10px] font-mono text-slate-500 mt-1">0.0 A</div>
                    </div>
                </div>

                <!-- LISTAS DE CIRCUITOS -->
                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center px-2"><h3 class="font-bold text-slate-700">üè† QD T√©rreo</h3><span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded font-bold">Quadro 1</span></div>
                        <div id="list-qd-terreo" class="space-y-2"></div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center px-2"><h3 class="font-bold text-slate-700">üõå QD Superior</h3><span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">Quadro 2</span></div>
                        <div id="list-qd-superior" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- ABA 3: MATERIAIS -->
            <div id="tab-bom" class="tab-content">
                <h2 class="text-xl font-bold text-slate-800 fun-font mb-4">Quantitativo e Custos</h2>
                <div id="bom-cables" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>
                <div id="bom-items" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
                
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-12">
                    <div class="bg-slate-900 text-white px-4 py-3"><h3 class="font-bold text-sm">Or√ßamento Detalhado</h3></div>
                    <div class="overflow-x-auto w-full">
                        <table class="w-full text-left text-sm min-w-[450px]">
                            <thead class="bg-slate-50 text-slate-500 border-b border-slate-200">
                                <tr><th class="p-3 font-semibold">Item</th><th class="p-3 text-center">Qtd</th><th class="p-3 text-right">Unit (R$)</th><th class="p-3 text-right">Total</th></tr>
                            </thead>
                            <tbody id="budget-tbody" class="divide-y divide-slate-100"></tbody>
                            <tfoot class="bg-yellow-50 text-slate-900 font-bold border-t-2 border-yellow-200">
                                <tr><td colspan="3" class="p-4 text-right uppercase text-xs tracking-wide">Total Geral</td><td id="budget-total" class="p-4 text-right text-lg text-indigo-700">R$ 0,00</td></tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MENU MOBILE -->
    <div id="mobile-menu" class="md:hidden hidden fixed bottom-0 w-full bg-white border-t border-slate-200 p-2 justify-around z-40 shadow-[0_-4px_15px_rgba(0,0,0,0.05)] safe-area-pb">
        <button onclick="window.app.setTab('rooms')" id="mob-rooms" class="flex-1 py-1 text-indigo-600 flex flex-col items-center gap-1"><span class="text-xl">üè°</span><span class="text-[9px] font-bold">Planta</span></button>
        <button onclick="window.app.setTab('circuits')" id="mob-circuits" class="flex-1 py-1 text-slate-400 flex flex-col items-center gap-1"><span class="text-xl">‚ö°</span><span class="text-[9px] font-bold">C√°lculos</span></button>
        <button onclick="window.app.setTab('bom')" id="mob-bom" class="flex-1 py-1 text-slate-400 flex flex-col items-center gap-1"><span class="text-xl">üìã</span><span class="text-[9px] font-bold">Materiais</span></button>
    </div>

    <!-- MODAL GEN√âRICO -->
    <div id="generic-modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-5 max-h-[90vh] overflow-y-auto">
            <h3 id="g-modal-title" class="text-lg font-bold text-slate-800 mb-2 fun-font"></h3>
            <div id="g-modal-content"></div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="window.app.closeModal()" class="px-4 py-2 text-slate-500 font-bold text-xs rounded-lg hover:bg-slate-50">Cancelar</button>
                <button id="g-modal-confirm" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold text-xs shadow">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT DA APLICA√á√ÉO -->
    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configura√ß√£o do Firebase (Chaves de exemplo)
        const firebaseConfig = { 
            apiKey: "AIzaSyByJ0jEYJm1ZbwJEWJy5uTwCVn2M3LA644", 
            authDomain: "elainehouse-c4b4b.firebaseapp.com", 
            projectId: "elainehouse-c4b4b", 
            storageBucket: "elainehouse-c4b4b.firebasestorage.app", 
            messagingSenderId: "105394705921", 
            appId: "1:105394705921:web:63c7993c59514ecd3ad200", 
            measurementId: "G-TKZ37YREMG" 
        };

        // Inicializa√ß√£o do Firebase
        const app = initializeApp(firebaseConfig); 
        const AUTH = getAuth(app); 
        const db = getFirestore(app);

        // ### V16 - CARGA COMPLETA (TUGS E LUZES) + AJUSTES EQUIPAMENTOS ###
        // Dados padr√£o do projeto (usados se o banco de dados estiver vazio)
        const defaultData = {
            settings: { 
                globalPF: 0.92, // Fator de Pot√™ncia Global
            },
            mainParams: { dist: 20 }, // Dist√¢ncia do padr√£o de entrada
            rooms: [
                { id: 1, name: "Garagem (Subsolo)", floor: "subsolo", type: "external", items: [
                    { id: 101, type: 'light', name: 'Ponto de Luz 1', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 102, type: 'light', name: 'Ponto de Luz 2', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 103, type: 'light', name: 'Ponto de Luz 3', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 104, type: 'light', name: 'Ponto de Luz 4', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 105, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }
                ] },
                { id: 2, name: "Sala Estar/Jantar", floor: "terreo", type: "living", items: [
                    { id: 201, type: 'light', name: 'Ponto de Luz 1', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 202, type: 'light', name: 'Ponto de Luz 2', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 203, type: 'light', name: 'Ponto de Luz 3', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 204, type: 'light', name: 'Ponto de Luz 4', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 205, type: 'light', name: 'Ponto de Luz 5', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 206, type: 'light', name: 'Ponto de Luz 6', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 207, type: 'light', name: 'Ponto de Luz 7', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 208, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }, 
                    { id: 209, type: 'outlet', name: 'TUG 2', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }, 
                    { id: 210, type: 'outlet', name: 'TUG 3', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }, 
                    { id: 211, type: 'outlet', name: 'TUG 4', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }
                ] },
                { id: 3, name: "Cozinha", floor: "terreo", type: "kitchen", items: [
                    { id: 3001, type: 'equipment', name: 'Lava-Lou√ßas', va: 1543, pf: 1.0, circuitId: 501 }, // ATUALIZADO
                    { id: 3002, type: 'equipment', name: 'Cooktop de Indu√ß√£o', va: 7000, pf: 1.0, circuitId: 502 },
                    { id: 3003, type: 'equipment', name: 'Forno El√©trico', va: 2422, pf: 1.0, circuitId: 504 },
                    { id: 301, type: 'light', name: 'Ponto de Luz 1', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 302, type: 'light', name: 'Ponto de Luz 2', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 303, type: 'light', name: 'Ponto de Luz 3', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 304, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }, 
                    { id: 305, type: 'outlet', name: 'TUG 2', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }, 
                    { id: 306, type: 'outlet', name: 'TUG 3', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }, 
                    { id: 307, type: 'outlet', name: 'TUG 4', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }
                ]},
                { id: 4, name: "Terra√ßo Gourmet", floor: "terreo", type: "kitchen", items: [
                    { id: 401, type: 'light', name: 'Ponto de Luz 1', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 402, type: 'light', name: 'Ponto de Luz 2', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 403, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }, 
                    { id: 404, type: 'outlet', name: 'TUG 2', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }
                ] },
                { id: 5, name: "√Årea de Servi√ßo", floor: "terreo", type: "kitchen", items: [
                    { id: 5001, type: 'equipment', name: 'M√°quina Lavar', va: 2280, pf: 1.0, circuitId: 503 },
                    { id: 501, type: 'light', name: 'Ponto de Luz', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 502, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }, 
                    { id: 503, type: 'outlet', name: 'TUG 2', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }
                ]},
                { id: 6, name: "Dep√≥sito", floor: "terreo", type: "living", items: [
                    { id: 601, type: 'light', name: 'Ponto de Luz', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 602, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }
                ] },
                { id: 7, name: "Quarto 01 (T√©rreo)", floor: "terreo", type: "living", items: [
                    { id: 701, type: 'equipment', name: 'Ar Condicionado 12000 BTU/h', va: 3822, pf: 0.92, circuitId: 401 },
                    { id: 702, type: 'light', name: 'Ponto de Luz', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 703, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }, 
                    { id: 704, type: 'outlet', name: 'TUG 2', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }
                ]},
                { id: 8, name: "WCB 01 Social", floor: "terreo", type: "bathroom", items: [
                    { id: 801, type: 'equipment', name: 'Chuveiro 6600W', va: 6600, pf: 1.0, circuitId: 301 },
                    { id: 802, type: 'light', name: 'Ponto de Luz', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 803, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }
                ]},
                { id: 9, name: "Su√≠te Master", floor: "superior", type: "living", items: [
                    { id: 901, type: 'equipment', name: 'Ar Condicionado 12000 BTU/h', va: 3822, pf: 0.92, circuitId: 402 },
                    { id: 902, type: 'light', name: 'Ponto de Luz 1', va: 100, pf: 1.0, circuitId: 101 }, 
                    { id: 903, type: 'light', name: 'Ponto de Luz 2', va: 100, pf: 1.0, circuitId: 101 }, 
                    { id: 904, type: 'light', name: 'Ponto de Luz 3', va: 100, pf: 1.0, circuitId: 101 }, 
                    { id: 905, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 102, customVA: 0, modules: 1 }, 
                    { id: 906, type: 'outlet', name: 'TUG 2', va: 0, pf: 0.92, circuitId: 102, customVA: 0, modules: 1 }
                ]},
                { id: 10, name: "Closet Master", floor: "superior", type: "living", items: [
                    { id: 1001, type: 'light', name: 'Ponto de Luz', va: 100, pf: 1.0, circuitId: 101 }, 
                    { id: 1002, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 102, customVA: 0, modules: 1 }
                ] },
                { id: 11, name: "WCB Su√≠te", floor: "superior", type: "bathroom", items: [
                    { id: 1101, type: 'equipment', name: 'Chuveiro 6600W', va: 6600, pf: 1.0, circuitId: 302 },
                    { id: 1102, type: 'light', name: 'Ponto de Luz', va: 100, pf: 1.0, circuitId: 101 }, 
                    { id: 1103, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 102, customVA: 0, modules: 1 }
                ]},
                { id: 12, name: "Escrit√≥rio", floor: "superior", type: "living", items: [
                    { id: 1201, type: 'equipment', name: 'Ar Condicionado 12000 BTU/h', va: 3822, pf: 0.92, circuitId: 403 },
                    { id: 1202, type: 'light', name: 'Ponto de Luz', va: 100, pf: 1.0, circuitId: 101 }, 
                    { id: 1203, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 102, customVA: 0, modules: 1 }, 
                    { id: 1204, type: 'outlet', name: 'TUG 2', va: 0, pf: 0.92, circuitId: 102, customVA: 0, modules: 1 }
                ]},
                { id: 13, name: "Quarto 02", floor: "superior", type: "living", items: [
                    { id: 1301, type: 'equipment', name: 'Ar Condicionado 12000 BTU/h', va: 3822, pf: 0.92, circuitId: 404 },
                    { id: 1302, type: 'light', name: 'Ponto de Luz', va: 100, pf: 1.0, circuitId: 101 }, 
                    { id: 1303, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 102, customVA: 0, modules: 1 }, 
                    { id: 1304, type: 'outlet', name: 'TUG 2', va: 0, pf: 0.92, circuitId: 102, customVA: 0, modules: 1 }
                ]},
                { id: 14, name: "Quarto 03", floor: "superior", type: "living", items: [
                    { id: 1401, type: 'equipment', name: 'Ar Condicionado 12000 BTU/h', va: 3822, pf: 0.92, circuitId: 405 },
                    { id: 1402, type: 'light', name: 'Ponto de Luz', va: 100, pf: 1.0, circuitId: 101 }, 
                    { id: 1403, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 102, customVA: 0, modules: 1 }, 
                    { id: 1404, type: 'outlet', name: 'TUG 2', va: 0, pf: 0.92, circuitId: 102, customVA: 0, modules: 1 }
                ]},
                { id: 15, name: "WCB 03 Social", floor: "superior", type: "bathroom", items: [
                    { id: 1501, type: 'equipment', name: 'Chuveiro 6600W', va: 6600, pf: 1.0, circuitId: 303 },
                    { id: 1502, type: 'light', name: 'Ponto de Luz', va: 100, pf: 1.0, circuitId: 101 }, 
                    { id: 1503, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 102, customVA: 0, modules: 1 }
                ]},
                { id: 16, name: "Circula√ß√£o", floor: "superior", type: "living", items: [
                    { id: 1601, type: 'light', name: 'Ponto de Luz 1', va: 100, pf: 1.0, circuitId: 101 }, 
                    { id: 1602, type: 'light', name: 'Ponto de Luz 2', va: 100, pf: 1.0, circuitId: 101 }
                ] },
                { id: 17, name: "WCB Servi√ßo (T√©rreo)", floor: "terreo", type: "bathroom", items: [ // 4¬∫ chuveiro
                    { id: 1701, type: 'equipment', name: 'Chuveiro 6600W', va: 6600, pf: 1.0, circuitId: 304 },
                    { id: 1702, type: 'light', name: 'Ponto de Luz', va: 100, pf: 1.0, circuitId: 1 }, 
                    { id: 1703, type: 'outlet', name: 'TUG 1', va: 0, pf: 0.92, circuitId: 2, customVA: 0, modules: 1 }
                ]}
            ],
            circuits: [
                { id: 1, name: "Ilumina√ß√£o T√©rreo", qd: "terreo", phase: "r", gauge: "1.5", usage: "lighting", dist: 20, pf: 1.0 },
                { id: 2, name: "TUGs T√©rreo", qd: "terreo", phase: "s", gauge: "2.5", usage: "power", dist: 15, pf: 0.92 },
                { id: 101, name: "Ilumina√ß√£o Superior", qd: "superior", phase: "t", gauge: "1.5", usage: "lighting", dist: 20, pf: 1.0 },
                { id: 102, name: "TUGs Superior", qd: "superior", phase: "r", gauge: "2.5", usage: "power", dist: 15, pf: 0.92 },
                { id: 301, name: "Chuveiro WCB 01", qd: "terreo", phase: "t", gauge: "6.0", usage: "specific", dist: 15, pf: 1.0, customAmp: 40 },
                { id: 302, name: "Chuveiro Su√≠te", qd: "superior", phase: "r", gauge: "6.0", usage: "specific", dist: 10, pf: 1.0, customAmp: 40 },
                { id: 303, name: "Chuveiro WCB 03", qd: "superior", phase: "s", gauge: "6.0", usage: "specific", dist: 15, pf: 1.0, customAmp: 40 },
                { id: 304, name: "Chuveiro WCB Servi√ßo", qd: "terreo", phase: "s", gauge: "6.0", usage: "specific", dist: 18, pf: 1.0, customAmp: 40 }, // 4¬∫ chuveiro
                { id: 401, name: "AC Quarto 01", qd: "terreo", phase: "r", gauge: "2.5", usage: "specific", dist: 15, pf: 0.92 },
                { id: 402, name: "AC Su√≠te", qd: "superior", phase: "t", gauge: "2.5", usage: "specific", dist: 10, pf: 0.92 },
                { id: 403, name: "AC Escrit√≥rio", qd: "superior", phase: "t", gauge: "2.5", usage: "specific", dist: 12, pf: 0.92 },
                { id: 404, name: "AC Quarto 02", qd: "superior", phase: "r", gauge: "2.5", usage: "specific", dist: 15, pf: 0.92 },
                { id: 405, name: "AC Quarto 03", qd: "superior", phase: "s", gauge: "2.5", usage: "specific", dist: 18, pf: 0.92 },
                { id: 501, name: "TUE Lava-Lou√ßas", qd: "terreo", phase: "s", gauge: "2.5", usage: "specific", dist: 15, pf: 1.0 }, // PF 1.0
                { id: 502, name: "TUE Cooktop", qd: "terreo", phase: "t", gauge: "6.0", usage: "specific", dist: 15, pf: 1.0, customAmp: 40 },
                { id: 503, name: "TUE Lava-Roupas", qd: "terreo", phase: "r", gauge: "2.5", usage: "specific", dist: 18, pf: 1.0 },
                { id: 504, name: "TUE Forno El√©trico", qd: "terreo", phase: "r", gauge: "2.5", usage: "specific", dist: 15, pf: 1.0 } // Forno
            ],
            prices: { // Pre√ßos de exemplo para or√ßamento
                outlet: 14.50, outlet2: 22.00, outlet3: 29.90, outlet20: 18.90, equipment: 0,
                light: 12.00, switch: 12.00, switch2: 18.90, switch3: 25.50, switch3w: 19.90, 
                breaker: 25.00, breakerMain: 120.00, dr: 180.00, board: 135.00, 
                'cable1.5': 1.60, 'cable2.5': 2.40, 'cable4.0': 4.80, 'cable6.0': 7.50, 'cable10.0': 14.00, 'cable16.0': 22.00, 'cable25.0': 35.00,
                'cable35.0': 45.00, 'cable50.0': 60.00, 'cable70.0': 80.00, 'cable95.0': 100.00, 'cable120.0': 120.00 // Pre√ßos adicionados
            }
        };

        // Constantes da NBR 5410
        const NBR = { 
            VOLTAGE: 220, // Tens√£o fase-neutro
            TUG_RULES: { // Regras de pot√™ncia para TUGs (Tomadas de Uso Geral)
                living: { base: 100, limit: 0 }, // Salas/Quartos: 100VA por ponto
                kitchen: { base: 600, limit: 3, extra: 100 }, // Cozinhas: 600VA nos 3 primeiros, 100VA nos seguintes
                bathroom: { base: 600, limit: 1 }, // Banheiros: 600VA em 1 ponto
                external: { base: 100, limit: 0 } // Externo: 100VA por ponto
            } 
        };

        // Vari√°veis globais da aplica√ß√£o
        let Project = JSON.parse(JSON.stringify(defaultData)); // Armazena os dados do projeto
        let DB_REF = null; // Refer√™ncia para o documento no Firestore
        let currentFloorFilter = 'all'; // Filtro de andar atual
        let SAVE_TIMER = null; // Timer para salvar automaticamente

        // Observador de Autentica√ß√£o do Firebase
        onAuthStateChanged(AUTH, u => {
            if(u) { // Se o usu√°rio est√° logado
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden'); document.getElementById('app-interface').classList.add('flex');
                document.getElementById('mobile-menu').classList.remove('hidden'); document.getElementById('mobile-menu').classList.add('flex');
                
                // Define a refer√™ncia do banco de dados para este usu√°rio
                DB_REF = doc(db, `users/${u.uid}/data/project_elaine_final_v16`); // v16 para nova estrutura
                
                // Ouve por mudan√ßas no banco de dados em tempo real
                onSnapshot(DB_REF, s => { 
                    if(s.exists()) { // Se o documento existe
                        Project = s.data(); // Carrega os dados
                        // Bloco para garantir compatibilidade com vers√µes antigas dos dados
                        if(!Project.prices) Project.prices = defaultData.prices;
                        if(!Project.mainParams) Project.mainParams = defaultData.mainParams;
                        if(!Project.settings) Project.settings = defaultData.settings;
                        Object.keys(defaultData.prices).forEach(k => { if(Project.prices[k] === undefined) Project.prices[k] = defaultData.prices[k]; });
                        
                        // Atualiza c√¥modos e circuitos com base nos dados padr√£o (para novos itens)
                        defaultData.rooms.forEach(defaultRoom => {
                            const projectRoom = Project.rooms.find(r => r.id === defaultRoom.id);
                            if (projectRoom) {
                                // Garante que itens padr√£o (equipamentos e TUDOS) sejam adicionados se n√£o existirem
                                defaultRoom.items.forEach(defaultItem => {
                                    if (!projectRoom.items.find(i => i.id === defaultItem.id)) { 
                                        projectRoom.items.push(defaultItem); 
                                    }
                                });
                            } else { 
                                Project.rooms.push(defaultRoom); // Adiciona c√¥modo novo
                            }
                        });
                        defaultData.circuits.forEach(dc => { 
                            if(!Project.circuits.find(c => c.id === dc.id)) {
                                Project.circuits.push(dc); // Adiciona circuito novo
                            }
                        });
                        
                        recalcAllTUGs(); // Recalcula pot√™ncias
                        renderAll(); // Renderiza a interface
                    } else saveCloud(true); // Se n√£o existe, salva os dados padr√£o
                });
            } else { // Se o usu√°rio n√£o est√° logado
                document.getElementById('auth-screen').classList.remove('hidden'); 
                document.getElementById('app-interface').classList.add('hidden'); 
                document.getElementById('mobile-menu').classList.add('hidden'); 
            }
        });

        // Fun√ß√£o para salvar no Firestore
        function saveCloud(immediate) { 
            if(DB_REF) { 
                clearTimeout(SAVE_TIMER); 
                const fn = () => setDoc(DB_REF, Project).catch(console.error); 
                if(immediate) fn(); // Salva imediatamente
                else SAVE_TIMER = setTimeout(fn, 1000); // Salva ap√≥s 1 segundo (evita excesso de escritas)
            } 
            renderAll(); // Atualiza a interface a cada salvamento
        }
        
        // Renderiza todas as se√ß√µes da UI
        function renderAll() { 
            renderRooms(); 
            renderCircuits(); 
            renderBOM(); 
        }

        // Recalcula pot√™ncias das TUGs baseado na NBR 5410
        function recalcAllTUGs() { 
            const pf = Project.settings?.globalPF || 0.92;
            Project.rooms.forEach(r => { 
                if(!r.type) return; 
                let tugs = r.items.filter(i => i.type === 'outlet'); 
                const rule = NBR.TUG_RULES[r.type] || NBR.TUG_RULES.living; 
                tugs.forEach((t, idx) => { 
                    if(t.customVA) { t.va = t.customVA; } // Usa VA customizado se existir
                    else { // Sen√£o, aplica a regra da NBR
                        if(rule.limit > 0) t.va = (idx < rule.limit) ? rule.base : (rule.extra || 100); 
                        else t.va = rule.base; 
                    } 
                    t.power = Math.round(t.va * (t.pf || pf)); 
                }); 
            }); 
        }

        // Renderiza a lista de c√¥modos
        function renderRooms() {
            const grid = document.getElementById('rooms-grid'); grid.innerHTML = '';
            // Filtra c√¥modos pelo andar selecionado
            const filtered = currentFloorFilter === 'all' ? Project.rooms : Project.rooms.filter(r => r.floor === currentFloorFilter);
            filtered.forEach(r => {
                const itemsHtml = r.items.map(i => {
                     let detail = ''; if(i.type==='outlet' || i.type==='switch') detail = `${i.modules||1} Se√ß√µes`; if(i.isThreeWay) detail = 'Three-Way';
                     let icon = 'üí°';
                     switch(i.type) {
                        case 'outlet': icon = 'üîå'; break;
                        case 'outlet20': icon = 'üõë'; break;
                        case 'switch': icon = 'üîò'; break;
                        case 'equipment': icon = (i.name.includes('Chuveiro') ? 'üöø' : (i.name.includes('Cooktop') ? 'üî•' : (i.name.includes('Forno') ? 'üç≥' : '‚ùÑÔ∏è') ) ); break;
                     }
                     
                     // L√≥gica de exibi√ß√£o de pot√™ncia customizada
                     let powerDisplay = `${i.va || '?'}VA`;
                     if (i.name.includes('Chuveiro')) { 
                         powerDisplay = `${Math.round(i.va * (i.pf || 1.0))}W`; 
                     } else if (i.name.includes('BTU/h')) { 
                         const btu = i.name.split(' ')[1] || '12000'; 
                         powerDisplay = `${btu} BTU/h`; 
                     } else if (i.name.includes('Cooktop') || i.name.includes('Forno') || i.name.includes('Lavar') || i.name.includes('Lava-Lou√ßas')) {
                         powerDisplay = `${Math.round(i.va * (i.pf || 1.0))}W`; 
                     }

                     // HTML para cada item (tomada, ilumina√ß√£o, etc)
                     return `<div class="flex justify-between items-center py-2 border-b border-slate-50 last:border-0 group"><div class="flex items-center gap-2"><div class="text-lg">${icon}</div><div><div class="flex items-center gap-1"><p class="text-xs font-bold text-slate-700 leading-none">${i.name}</p>${getCircuitBadge(i.circuitId)}</div><div class="flex items-center gap-1 mt-0.5"><button onclick="window.app.editItem(${r.id}, ${i.id})" class="text-[9px] font-mono text-indigo-600 bg-indigo-50 px-1 rounded hover:bg-indigo-100">${powerDisplay} ${detail} ‚úèÔ∏è</button></div></div></div><button onclick="window.app.delItem(${r.id}, ${i.id})" class="text-slate-300 hover:text-red-500 p-1">‚úï</button></div>`;
                }).join('');
                // HTML para o card do c√¥modo
                grid.innerHTML += `<div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 card-hover relative"><div class="flex justify-between items-start mb-2"><div><span class="text-[9px] uppercase font-bold tracking-wider bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">${r.floor}</span><h3 class="font-bold text-lg text-slate-800 fun-font">${r.name}</h3></div><button onclick="window.app.modalAddItem(${r.id})" class="w-7 h-7 rounded-lg bg-indigo-50 text-indigo-600 font-bold">+</button></div><div class="space-y-1">${itemsHtml || '<div class="text-center text-xs text-slate-300 italic py-4">Vazio</div>'}</div></div>`;
            });
        }

        // Renderiza a aba de c√°lculos (Circuitos e Geral)
        function renderCircuits() {
            const qdT = document.getElementById('list-qd-terreo'); const qdS = document.getElementById('list-qd-superior'); qdT.innerHTML = ''; qdS.innerHTML = '';
            let loadsW = { r:0, s:0, t:0 }; let loadsVA = { r:0, s:0, t:0 }; // Cargas por fase (INSTALADA)
            const globalPF = Project.settings?.globalPF || 0.92;
            
            // Calcula a carga total de cada circuito (para balanceamento)
            Project.circuits.forEach(c => {
                let va = 0; Project.rooms.forEach(r => r.items.forEach(i => { if(i.circuitId == c.id) va += (i.va || 0); }));
                const pf = c.pf || (c.usage === 'lighting' ? 1.0 : globalPF);
                const watts = va * pf;
                const finalAmps = c.customAmp > 0 ? c.customAmp : (va / NBR.VOLTAGE); // Usa corrente customizada (chuveiro) ou calcula
                if(loadsW[c.phase] !== undefined) { loadsW[c.phase] += watts; loadsVA[c.phase] += va; }
                
                // HTML para o card do circuito
                const html = `<div class="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 shadow-sm group"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold text-white uppercase ${c.phase==='r'?'bg-phase-r':c.phase==='s'?'bg-phase-s':'bg-phase-t'}">${c.phase}</div><div><p class="text-sm font-bold text-slate-700 leading-none">${c.name}</p><p class="text-[10px] text-slate-400 font-mono mt-0.5">${va}VA (FP ${pf}) ‚Ä¢ ${finalAmps.toFixed(1)}A ‚Ä¢ ${c.gauge}mm¬≤ ‚Ä¢ ${c.dist||15}m</p></div></div><div class="flex gap-1"><button onclick="window.app.editCircuit(${c.id})" class="bg-slate-100 text-indigo-600 text-[10px] font-bold px-2 py-1 rounded">‚úèÔ∏è</button><button onclick="window.app.delCirc(${c.id})" class="text-slate-300 hover:text-red-500 px-2">‚úï</button></div></div>`;
                if(c.qd === 'terreo') qdT.innerHTML += html; else qdS.innerHTML += html;
            });
            
            // Atualiza balanceamento de fases (Carga Instalada)
            const totalW_Installed = loadsW.r + loadsW.s + loadsW.t;
            const totalVA_Installed = loadsVA.r + loadsVA.s + loadsVA.t;
            const ampsR = loadsVA.r / 220;
            const ampsS = loadsVA.s / 220;
            const ampsT = loadsVA.t / 220;
            document.getElementById(`load-r-w`).innerText = Math.round(loadsW.r) + ' W'; document.getElementById(`load-r-a`).innerText = ampsR.toFixed(1) + ' A';
            document.getElementById(`load-s-w`).innerText = Math.round(loadsW.s) + ' W'; document.getElementById(`load-s-a`).innerText = ampsS.toFixed(1) + ' A';
            document.getElementById(`load-t-w`).innerText = Math.round(loadsW.t) + ' W'; document.getElementById(`load-t-a`).innerText = ampsT.toFixed(1) + ' A';


            // ### V15 - NOVO C√ÅLCULO DE DEMANDA GERAL ###
            
            // 1. Coletar cargas instaladas por grupo (em Watts)
            let installedLoadsW = { d1_light: 0, d1_tug: 0, d2_shower: 0, d3_wash: 0, d4_cook: 0, d5_ac: 0, d_other: 0 };
            Project.rooms.forEach(r => {
                r.items.forEach(i => {
                    const watts = i.va * (i.pf || (i.type === 'outlet' ? globalPF : 1.0)); // TUGs usam PF global, resto usa PF pr√≥prio ou 1.0
                    
                    if (i.type === 'light') { installedLoadsW.d1_light += watts; }
                    else if (i.type === 'outlet' || i.type === 'outlet20') { installedLoadsW.d1_tug += watts; }
                    else if (i.name.includes('Chuveiro')) { installedLoadsW.d2_shower += watts; }
                    else if (i.name.includes('Lava-Lou√ßas') || i.name.includes('M√°quina Lavar')) { installedLoadsW.d3_wash += watts; }
                    else if (i.name.includes('Cooktop') || i.name.includes('Forno El√©trico')) { installedLoadsW.d4_cook += watts; }
                    else if (i.name.includes('Ar Condicionado')) { installedLoadsW.d5_ac += watts; }
                    else if (i.type === 'equipment') { installedLoadsW.d_other += watts; } // Outros equipamentos
                });
            });

            // 2. Aplicar fatores de demanda para obter d(KW)
            const d1_total_W = installedLoadsW.d1_light + installedLoadsW.d1_tug + installedLoadsW.d_other;
            const d1_kw = (d1_total_W * 0.27) / 1000;
            const d2_kw = (installedLoadsW.d2_shower * 0.66) / 1000;
            const d3_kw = (installedLoadsW.d3_wash * 0.70) / 1000;
            const d4_kw = (installedLoadsW.d4_cook * 0.60) / 1000;
            const d5_kw = (installedLoadsW.d5_ac * 0.76) / 1000;
            
            const d_KW_total = d1_kw + d2_kw + d3_kw + d4_kw + d5_kw; // Demanda Ativa Total (kW)
            const totalDemandW = d_KW_total * 1000; // Demanda Ativa Total (W)

            // 3. Calcular Demanda Aparente Total D(KVA)
            const D_KVA_total = d_KW_total / 0.92;
            const totalDemandVA = D_KVA_total * 1000;

            // 4. Calcular Corrente do Disjuntor Geral (Amperes)
            // I = P(W) / (V_linha * sqrt(3) * FP) = (d_KW_total * 1000) / (380 * 1.73 * 0.92)
            const I_geral_A = totalDemandW / (1.732 * 0.92 * 380); // Aprox 603.85

            // 5. Dimensionar Disjuntor e Cabo Geral
            const breakers = [10, 16, 20, 25, 32, 40, 50, 63, 70, 80, 100, 125, 150, 175, 200, 225];
            let mainBreaker = breakers.find(b => b >= I_geral_A) || 225;
            
            let mainCable = '10.0';
            if (I_geral_A > 50) mainCable = '16.0';
            if (I_geral_A > 63) mainCable = '25.0';
            if (I_geral_A > 80) mainCable = '35.0';
            if (I_geral_A > 100) mainCable = '50.0';
            if (I_geral_A > 125) mainCable = '70.0';
            if (I_geral_A > 150) mainCable = '95.0';
            if (I_geral_A > 175) mainCable = '120.0';
            if (I_geral_A > 200) mainCable = '150.0';

            // 6. Atualiza painel geral
            document.getElementById('gen-breaker').innerText = mainBreaker + ' A';
            const effectiveDemandFactor = totalDemandVA / totalVA_Installed;
            document.getElementById('gen-demand-factor').innerText = `Demanda: ${Math.round(effectiveDemandFactor * 100)}%`;
            document.getElementById('gen-cable').innerText = mainCable + ' mm¬≤';
            document.getElementById('gen-dist').innerText = `Dist: ${Project.mainParams?.dist || 20} m`;
            document.getElementById('gen-load-w').innerText = Math.round(totalDemandW) + ' W';
            document.getElementById('gen-load-va-demand').innerText = Math.round(totalDemandVA) + ' VA';
            document.getElementById('gen-load-va-total').innerText = `Instal.: ${Math.round(totalVA_Installed)} VA`; // Mostra VA total instalado
            
            // 7. Salva par√¢metros globais para uso na lista de materiais
            window.calcParams = { mainBreaker, mainCable, maxAmp: I_geral_A };
        }

        // Renderiza a lista de materiais (BOM) e or√ßamento
        function renderBOM() {
            const bomItems = document.getElementById('bom-items'); const bomCables = document.getElementById('bom-cables'); const tb = document.getElementById('budget-tbody');
            // Contadores de materiais
            let tug = { '1':0, '2':0, '3':0 }; let tue = { '20a':0, 'eqp':0 }; let sw = { '1':0, '2':0, '3':0, '3w':0 }; let lights = 0; let brk = Project.circuits.length;
            let cableColors = {
                'r': { name: 'Fase R (Vermelho)', class: 'bg-red-500', items: {} },
                's': { name: 'Fase S (Preto)', class: 'bg-slate-900', items: {} },
                't': { name: 'Fase T (Amarelo)', class: 'bg-yellow-400 text-black', items: {} },
                'n': { name: 'Neutro (Azul)', class: 'bg-blue-500', items: {} },
                'pe': { name: 'Terra (Verde)', class: 'bg-green-500', items: {} }
            };

            // Conta tomadas, interruptores, etc.
            Project.rooms.forEach(r => r.items.forEach(i => {
                if(i.type==='outlet') { let m = i.modules || 1; if(tug[m] !== undefined) tug[m]++; }
                else if(i.type==='outlet20') { tue['20a']++; }
                else if(i.type==='equipment') { tue['eqp']++; }
                else if(i.type==='switch') { if(i.isThreeWay) sw['3w']++; else { let m = i.modules || 1; if(sw[m] !== undefined) sw[m]++; } }
                else if(i.type==='light') lights++;
            }));

            // Calcula metragem de cabos por circuito (F+N+T)
            Project.circuits.forEach(c => {
                const dist = (Number(c.dist)||15) * 1.1; const g = c.gauge; // Dist√¢ncia + 10%
                if(!cableColors[c.phase].items[g]) cableColors[c.phase].items[g] = 0; cableColors[c.phase].items[g] += dist;
                if(!cableColors['n'].items[g]) cableColors['n'].items[g] = 0; cableColors['n'].items[g] += dist;
                if(!cableColors['pe'].items[g]) cableColors['pe'].items[g] = 0; cableColors['pe'].items[g] += dist;
            });

            // Adiciona cabos de entrada (F+F+F+N+T)
            const mainDist = (Project.mainParams?.dist || 20) * 1.1;
            const mainGauge = window.calcParams?.mainCable || '10.0';
            ['r','s','t','n','pe'].forEach(k => { if(!cableColors[k].items[mainGauge]) cableColors[k].items[mainGauge] = 0; cableColors[k].items[mainGauge] += mainDist; });

            // Renderiza cards de cabos
            bomCables.innerHTML = '';
            Object.keys(cableColors).forEach(k => {
                const color = cableColors[k]; const entries = Object.entries(color.items); if(entries.length === 0) return;
                let listHtml = entries.map(([g, len]) => `<div class="flex justify-between text-xs border-b border-slate-100 py-1 last:border-0"><span class="font-mono text-slate-500">${g}mm¬≤</span><span class="font-bold text-slate-700">${Math.ceil(len)}m</span></div>`).join('');
                bomCables.innerHTML += `<div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm"><div class="${color.class} px-3 py-2 text-xs font-bold text-white flex justify-between items-center"><span>${color.name}</span><span>üè≥Ô∏è</span></div><div class="p-3 space-y-1">${listHtml}</div></div>`;
            });

            // Renderiza cards de itens gerais
            bomItems.innerHTML = `
                <div class="bg-white rounded-xl p-4 border border-slate-200">
                    <h4 class="font-bold text-indigo-800 text-xs uppercase mb-3">Itens Gerais</h4>
                    <div class="space-y-1.5 text-xs text-slate-600">
                        <div class="flex justify-between border-b border-slate-50 pb-1"><span>Disjuntor Geral</span><b>${window.calcParams?.mainBreaker}A</b></div>
                        <div class="flex justify-between border-b border-slate-50 pb-1"><span>Dispositivo DR</span><b>${window.calcParams?.mainBreaker}A</b></div>
                        <div class="flex justify-between border-b border-slate-50 pb-1"><span>Cabo Entrada</span><b>${window.calcParams?.mainCable}mm</b></div>
                        <div class="flex justify-between text-slate-400"><span>Dist√¢ncia Geral</span><b>${Project.mainParams?.dist}m</b></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 border border-slate-200">
                    <h4 class="font-bold text-slate-800 text-xs uppercase mb-3">Interruptores</h4>
                    <div class="space-y-1.5 text-xs text-slate-600">
                        <div class="flex justify-between border-b border-slate-50 pb-1"><span>1 Tecla</span><b>${sw[1]}</b></div>
                        <div class="flex justify-between border-b border-slate-50 pb-1"><span>2 Teclas</span><b>${sw[2]}</b></div>
                        <div class="flex justify-between pt-1 text-indigo-600 font-bold"><span>3-Way</span><b>${sw['3w']}</b></div>
                    </div>
                </div>
            `;

            // Renderiza tabela de or√ßamento
            tb.innerHTML = ''; let total = 0;
            const addRow = (label, qty, priceKey) => { if(qty <= 0) return; const price = Project.prices[priceKey] || 0; const sub = qty * price; total += sub; tb.innerHTML += `<tr class="hover:bg-slate-50"><td class="p-3 text-slate-700 whitespace-nowrap">${label}</td><td class="p-3 text-center font-bold text-slate-500">${qty}</td><td class="p-3 text-right"><button onclick="window.app.editPrice('${priceKey}')" class="text-indigo-600 text-xs font-bold bg-indigo-50 px-1.5 py-0.5 rounded whitespace-nowrap">R$ ${price.toFixed(2)}</button></td><td class="p-3 text-right font-bold whitespace-nowrap">R$ ${sub.toFixed(2)}</td></tr>`; };

            addRow(`Disjuntor Geral Tripolar ${window.calcParams?.mainBreaker}A`, 1, 'breakerMain');
            addRow(`Dispositivo DR Tetrapolar ${window.calcParams?.mainBreaker}A`, 1, 'dr');
            addRow('Disjuntor DIN Monopolar (Circuitos)', brk, 'breaker');
            addRow('Quadro Distribui√ß√£o', 2, 'board');
            addRow('Tomada (Conj. 1 m√≥dulo)', tug[1], 'outlet');
            addRow('Tomada (Conj. 2 m√≥dulos)', tug[2], 'outlet2');
            addRow('Tomada (Conj. 3 m√≥dulos)', tug[3], 'outlet3');
            addRow('Tomada 20A (Espec√≠fica)', tue['20a'], 'outlet20');
            addRow('Sa√≠da Fio (Chuveiro/Ar/Etc)', tue['eqp'], 'equipment');
            addRow('Interruptor (1 Tecla)', sw[1], 'switch');
            addRow('Interruptor (2 Teclas)', sw[2], 'switch2');
            addRow('Interruptor (3 Teclas)', sw[3], 'switch3');
            addRow('Interruptor Three-Way', sw['3w'], 'switch3w');
            addRow('Ponto de Luz', lights, 'light');
            // Adiciona cabos ao or√ßamento
            Object.keys(cableColors).forEach(colorKey => {
                const colorData = cableColors[colorKey]; const colorName = colorData.name.split(' (')[0]; const colorLabelMap = { 'r': 'Vermelho', 's': 'Preto', 't': 'Amarelo', 'n': 'Azul', 'pe': 'Verde' };
                Object.entries(colorData.items).forEach(([gauge, length]) => { if (length > 0) addRow(`Cabo ${gauge}mm¬≤ ${colorLabelMap[colorKey]} (${colorName})`, Math.ceil(length), `cable${gauge}`); });
            });
            document.getElementById('budget-total').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        }

        // Helper para obter o badge do circuito
        function getCircuitBadge(id) { const c = Project.circuits.find(x => x.id == id); return c ? `<span class="text-[9px] font-bold ${c.phase==='r'?'text-red-500':c.phase==='s'?'text-slate-900':'text-yellow-600'} bg-slate-50 px-1 border rounded ml-1">C${Project.circuits.indexOf(c)+1}</span>` : ''; }

        // Objeto global 'app' com todas as fun√ß√µes de intera√ß√£o
        window.app = {
            closeModal: () => document.getElementById('generic-modal').classList.add('hidden'),
            
            // ### V15 - Modal de Config Simplificado ###
            editSettings: () => {
                const el = document.getElementById('generic-modal'); document.getElementById('g-modal-title').innerText = "Configura√ß√µes Globais";
                document.getElementById('g-modal-content').innerHTML = `
                <label class="text-xs text-slate-500 block mb-1">Fator de Pot√™ncia Padr√£o (FP)</label>
                <input id="m-pf" type="number" step="0.01" class="w-full border p-2 rounded mb-3" value="${Project.settings?.globalPF || 0.92}">
                <p class="text-[10px] text-slate-400 mt-1">O Fator de Demanda agora √© calculado por grupos (d1 a d5) e n√£o pode ser editado globalmente.</p>`;
                el.classList.remove('hidden'); el.classList.add('flex');
                document.getElementById('g-modal-confirm').onclick = () => { 
                    Project.settings.globalPF = Number(document.getElementById('m-pf').value); 
                    recalcAllTUGs(); saveCloud(); window.app.closeModal(); 
                };
            },
            editMainParams: () => {
                 const el = document.getElementById('generic-modal'); document.getElementById('g-modal-title').innerText = "Dist√¢ncia Padr√£o -> Quadro";
                 document.getElementById('g-modal-content').innerHTML = `<label class="text-xs text-slate-500 block mb-1">Dist√¢ncia em Metros</label><input id="m-dist" type="number" class="w-full border p-2 rounded" value="${Project.mainParams?.dist || 20}">`;
                 el.classList.remove('hidden'); el.classList.add('flex');
                 document.getElementById('g-modal-confirm').onclick = () => { Project.mainParams = { dist: Number(document.getElementById('m-dist').value) }; saveCloud(); window.app.closeModal(); };
            },
            promptAddRoom: () => {
                const el = document.getElementById('generic-modal'); document.getElementById('g-modal-title').innerText = "Novo Ambiente";
                document.getElementById('g-modal-content').innerHTML = `<div class="space-y-3">
                    <input id="m-r-name" class="w-full border p-2 rounded text-sm" placeholder="Nome (Ex: Sala)">
                    <select id="m-r-floor" class="w-full border p-2 rounded text-sm bg-white"><option value="terreo">T√©rreo</option><option value="superior">Superior</option><option value="subsolo">Subsolo</option></select>
                    <select id="m-r-type" class="w-full border p-2 rounded text-sm bg-white font-bold text-indigo-700"><option value="living">üõãÔ∏è Sala / Quarto (100VA)</option><option value="kitchen">üç≥ Cozinha (600VA)</option><option value="bathroom">üöø Banheiro (600VA)</option><option value="external">üåø Externo (100VA)</option></select>
                    <input id="m-r-tugs" type="number" class="w-full border p-2 rounded text-sm" placeholder="Quantas TUGs (Uso Geral)?">
                </div>`;
                el.classList.remove('hidden'); el.classList.add('flex');
                document.getElementById('g-modal-confirm').onclick = () => {
                    const n = document.getElementById('m-r-name').value;
                    if(n) {
                        const newRoom = { id:Date.now(), name:n, floor:document.getElementById('m-r-floor').value, type:document.getElementById('m-r-type').value, items:[] };
                        // Adiciona TUGs automaticamente baseado na NBR
                        const tugCount = Number(document.getElementById('m-r-tugs').value) || 0;
                        const roomType = newRoom.type;
                        const rule = NBR.TUG_RULES[roomType] || NBR.TUG_RULES.living;
                        const globalPF = Project.settings?.globalPF || 0.92;
                        for (let i = 0; i < tugCount; i++) {
                            let va = rule.base; if (rule.limit > 0 && i >= rule.limit) { va = rule.extra || 100; }
                            newRoom.items.push({ id: Date.now() + i, type: 'outlet', name: `TUG ${i + 1}`, va: va, power: Math.round(va * globalPF), customVA: 0, modules: 1, isThreeWay: false, circuitId: null });
                        }
                        Project.rooms.push(newRoom); saveCloud(); window.app.closeModal();
                    }
                };
            },
            modalAddItem: (rid) => {
                const el = document.getElementById('generic-modal'); document.getElementById('g-modal-title').innerText = "Adicionar Ponto";
                const circs = Project.circuits.map(c => `<option value="${c.id}">${c.name} (${c.phase.toUpperCase()})</option>`).join('');
                document.getElementById('g-modal-content').innerHTML = `<div class="space-y-3 text-sm"><div class="grid grid-cols-2 gap-2"><select id="m-i-type" class="border p-2 rounded bg-white" onchange="toggleFields()"><option value="outlet">üîå Tomada TUG</option><option value="outlet20">üõë Tomada 20A</option><option value="switch">üîò Interruptor</option><option value="light">üí° Ilumina√ß√£o</option><option value="equipment">‚ùÑÔ∏è Ar/Chuveiro/Outro</option></select><input id="m-i-name" class="border p-2 rounded" placeholder="Nome"></div><div id="div-modules" class="grid grid-cols-2 gap-2"><select id="m-i-mod" class="border p-2 rounded bg-white"><option value="1">1 Se√ß√£o</option><option value="2">2 Se√ß√µes</option><option value="3">3 Se√ß√µes</option></select><label class="flex items-center gap-2 border p-2 rounded bg-slate-50"><input type="checkbox" id="m-i-3w"> Three-Way</label></div><div id="div-power"><input id="m-i-va" type="number" class="w-full border p-2 rounded" placeholder="Pot√™ncia (VA)"><p class="text-[10px] text-slate-400 mt-1">Vazio = Auto NBR (p/ TUG)</p></div><select id="m-i-circ" class="w-full border p-2 rounded bg-white"><option value="">Sem Circuito</option>${circs}</select></div><script>function toggleFields(){const t=document.getElementById('m-i-type').value; const m=document.getElementById('div-modules'); if(t==='outlet'||t==='switch') m.classList.remove('hidden'); else m.classList.add('hidden');}<\/script>`;
                el.classList.remove('hidden'); el.classList.add('flex');
                document.getElementById('g-modal-confirm').onclick = () => {
                    const type = document.getElementById('m-i-type').value; let va = Number(document.getElementById('m-i-va').value); const r = Project.rooms.find(x => x.id === rid); let customVA = va > 0 ? va : 0;
                    if(type === 'outlet' && !va) { const tempIdx = r.items.filter(i => i.type === 'outlet').length; const rule = NBR.TUG_RULES[r.type] || NBR.TUG_RULES.living; if(rule.limit > 0) va = (tempIdx < rule.limit) ? rule.base : (rule.extra||100); else va = rule.base; } if(!va) va = (type === 'light') ? 100 : 0;
                    r.items.push({ id: Date.now(), type, name: document.getElementById('m-i-name').value || 'Ponto', va, power: Math.round(va*(Project.settings?.globalPF||0.92)), customVA, modules: Number(document.getElementById('m-i-mod').value)||1, isThreeWay: document.getElementById('m-i-3w').checked, circuitId: document.getElementById('m-i-circ').value, pf: 1.0 });
                    recalcAllTUGs(); saveCloud(); window.app.closeModal();
                };
            },
            // ### FUN√á√ÉO EDITITEM ATUALIZADA ###
            editItem: (rid, iid) => {
                const r = Project.rooms.find(x => x.id === rid); if(!r) return; const i = r.items.find(x => x.id === iid); if(!i) return;
                const el = document.getElementById('generic-modal'); document.getElementById('g-modal-title').innerText = "Editar Item";
                const circs = Project.circuits.map(c => `<option value="${c.id}" ${c.id==i.circuitId?'selected':''}>${c.name} (${c.phase.toUpperCase()})</option>`).join('');
                
                // Bloco de HTML condicional para se√ß√µes e 3-way
                let modulesHtml = '';
                if (i.type === 'outlet' || i.type === 'switch') {
                    modulesHtml = `
                    <div class="grid grid-cols-2 gap-2">
                        <select id="ei-mod" class="border p-2 rounded bg-white">
                            <option value="1" ${ (i.modules || 1) == 1 ? 'selected' : ''}>1 Se√ß√£o</option>
                            <option value="2" ${ (i.modules || 1) == 2 ? 'selected' : ''}>2 Se√ß√µes</option>
                            <option value="3" ${ (i.modules || 1) == 3 ? 'selected' : ''}>3 Se√ß√µes</option>
                        </select>
                        <label class="flex items-center gap-2 border p-2 rounded bg-slate-50 ${i.type === 'switch' ? '' : 'hidden'}">
                            <input type="checkbox" id="ei-3w" ${i.isThreeWay ? 'checked' : ''}> Three-Way
                        </label>
                    </div>`;
                }
                
                // HTML do modal atualizado
                document.getElementById('g-modal-content').innerHTML = `
                <div class="space-y-3 text-sm">
                    <input id="ei-name" class="w-full border p-2 rounded" value="${i.name}">
                    <div class="grid grid-cols-2 gap-2">
                        <input id="ei-va" type="number" class="border p-2 rounded" value="${i.va}" placeholder="Pot√™ncia VA">
                        <select id="ei-circ" class="border p-2 rounded bg-white"><option value="">--Sem Circuito--</option>${circs}</select>
                    </div>
                    ${modulesHtml}
                </div>`;
                
                el.classList.remove('hidden'); el.classList.add('flex');
                
                // L√≥gica de confirma√ß√£o atualizada
                document.getElementById('g-modal-confirm').onclick = () => { 
                    i.name = document.getElementById('ei-name').value; 
                    i.va = Number(document.getElementById('ei-va').value); 
                    i.customVA = i.va; 
                    i.power = Math.round(i.va * (i.pf || Project.settings?.globalPF||0.92)); 
                    i.circuitId = document.getElementById('ei-circ').value; 
                    
                    // Salva m√≥dulos e 3-way
                    if (i.type === 'outlet' || i.type === 'switch') {
                        i.modules = Number(document.getElementById('ei-mod').value) || 1;
                        if (i.type === 'switch') {
                            i.isThreeWay = document.getElementById('ei-3w').checked;
                        }
                    }
                    
                    saveCloud(); 
                    window.app.closeModal(); 
                };
            },
            editCircuit: (cid) => {
                const c = Project.circuits.find(x => x.id === cid); if(!c) return;
                const el = document.getElementById('generic-modal'); document.getElementById('g-modal-title').innerText = `Ajustar Circuito`;
                document.getElementById('g-modal-content').innerHTML = `<div class="space-y-3 text-sm"><input id="ec-name" class="w-full border p-2 rounded" value="${c.name}"><div class="grid grid-cols-2 gap-2"><select id="ec-qd" class="w-full border p-2 rounded bg-white"><option value="terreo" ${c.qd=='terreo'?'selected':''}>T√©rreo</option><option value="superior" ${c.qd=='superior'?'selected':''}>Superior</option></select><select id="ec-phase" class="w-full border p-2 rounded bg-white"><option value="r" ${c.phase=='r'?'selected':''}>Fase R (Verm)</option><option value="s" ${c.phase=='s'?'selected':''}>Fase S (Preto)</option><option value="t" ${c.phase=='t'?'selected':''}>Fase T (Amar)</option></select></div><div class="grid grid-cols-2 gap-2"><select id="ec-gauge" class="w-full border p-2 rounded bg-white"><option value="1.5" ${c.gauge=='1.5'?'selected':''}>1.5mm</option><option value="2.5" ${c.gauge=='2.5'?'selected':''}>2.5mm</option><option value="4.0" ${c.gauge=='4.0'?'selected':''}>4.0mm</option><option value="6.0" ${c.gauge=='6.0'?'selected':''}>6.0mm</option><option value="10.0" ${c.gauge=='10.0'?'selected':''}>10mm</option></select><input id="ec-dist" type="number" class="w-full border p-2 rounded" value="${c.dist || 15}" placeholder="Dist. (m)"></div><input id="ec-amp" type="number" class="w-full border p-2 rounded border-yellow-300 bg-yellow-50" value="${c.customAmp || 0}" placeholder="Corrente Fixa (Opcional)"></div>`;
                el.classList.remove('hidden'); el.classList.add('flex');
                document.getElementById('g-modal-confirm').onclick = () => { c.name = document.getElementById('ec-name').value; c.qd = document.getElementById('ec-qd').value; c.phase = document.getElementById('ec-phase').value; c.gauge = document.getElementById('ec-gauge').value; c.customAmp = parseFloat(document.getElementById('ec-amp').value) || 0; c.dist = parseFloat(document.getElementById('ec-dist').value) || 15; saveCloud(); window.app.closeModal(); };
            },
            promptAddCircuit: () => {
                const el = document.getElementById('generic-modal'); document.getElementById('g-modal-title').innerText = "Novo Circuito";
                document.getElementById('g-modal-content').innerHTML = `<div class="space-y-3 text-sm"><input id="c-name" class="w-full border p-2 rounded" placeholder="Nome"><div class="grid grid-cols-2 gap-2"><select id="c-qd" class="border p-2 rounded bg-white"><option value="terreo">T√©rreo</option><option value="superior">Superior</option></select><select id="c-phase" class="border p-2 rounded bg-white font-bold"><option value="r">Fase R</option><option value="s">Fase S</option><option value="t">Fase T</option></select></div><select id="c-gauge" class="w-full border p-2 rounded bg-white"><option value="1.5">1.5mm</option><option value="2.5">2.5mm</option><option value="4.0">4.0mm</option><option value="6.0">6.0mm</option></select></div>`;
                el.classList.remove('hidden'); el.classList.add('flex');
                document.getElementById('g-modal-confirm').onclick = () => { Project.circuits.push({ id: Date.now(), name: document.getElementById('c-name').value, qd: document.getElementById('c-qd').value, phase: document.getElementById('c-phase').value, gauge: document.getElementById('c-gauge').value, dist: 15, customAmp: 0, pf: Project.settings?.globalPF||0.92, usage: 'power' }); saveCloud(); window.app.closeModal(); };
            },
            editPrice: (k) => {
                 const el = document.getElementById('generic-modal'); document.getElementById('g-modal-title').innerText = "Editar Pre√ßo";
                 document.getElementById('g-modal-content').innerHTML = `<input id="m-price" type="number" class="w-full border p-2 rounded" step="0.01" value="${Project.prices[k]}">`;
                 el.classList.remove('hidden'); el.classList.add('flex');
                 document.getElementById('g-modal-confirm').onclick = () => { Project.prices[k] = Number(document.getElementById('m-price').value); saveCloud(); window.app.closeModal(); };
            },
            // Fun√ß√µes de exclus√£o
            delItem: (rid, iid) => { const r = Project.rooms.find(x => x.id === rid); if(r){ r.items = r.items.filter(i => i.id !== iid); recalcAllTUGs(); saveCloud(); } },
            delRoom: (id) => { Project.rooms = Project.rooms.filter(x => x.id !== id); saveCloud(); },
            delCirc: (id) => { Project.circuits = Project.circuits.filter(x => x.id !== id); saveCloud(); },
            // Navega√ß√£o
            filterFloor: (f, btn) => { currentFloorFilter = f; document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderRooms(); },
            setTab: (id) => { 
                document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); 
                document.getElementById('tab-'+id).classList.add('active'); 
                // Atualiza abas do desktop
                document.querySelectorAll('#mobile-menu button, .md\\:flex .gap-1 button').forEach(b => b.classList.remove('text-indigo-600', 'bg-white', 'shadow-sm'));
                document.querySelectorAll('.md\\:flex .gap-1 button').forEach(b => b.classList.add('text-slate-500'));
                document.querySelectorAll('#nav-'+id).forEach(b=>b.classList.add('text-indigo-600', 'bg-white', 'shadow-sm'));
                document.querySelectorAll('#nav-'+id).forEach(b=>b.classList.remove('text-slate-500'));
                // Atualiza abas mobile
                document.querySelectorAll('#mobile-menu button').forEach(b => b.classList.add('text-slate-400'));
                document.querySelectorAll('#mob-'+id).forEach(b=>b.classList.add('text-indigo-600'));
                document.querySelectorAll('#mob-'+id).forEach(b=>b.classList.remove('text-slate-400'));
            },
            // Fun√ß√µes de Autentica√ß√£o
            switchAuthMode: m => { 
                document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active')); 
                document.getElementById('tab-'+m).classList.add('active'); 
                document.getElementById('btn-auth-action').innerText = m==='login'?'ACESSAR PROJETO':'CRIAR CONTA'; 
            },
            handleAuthAction: async () => {
                const e = document.getElementById('auth-email').value; const p = document.getElementById('auth-pass').value; 
                const btn = document.getElementById('btn-auth-action'); const errorDiv = document.getElementById('auth-error');
                if(!e || !p) { 
                    btn.classList.add('shake'); setTimeout(() => btn.classList.remove('shake'), 500); 
                    errorDiv.innerText = "Preencha e-mail e senha!"; errorDiv.classList.remove('hidden'); return; 
                }
                btn.innerText = "Carregando..."; btn.disabled = true; errorDiv.classList.add('hidden');
                try { 
                    if(document.getElementById('tab-login').classList.contains('active')) 
                        await signInWithEmailAndPassword(AUTH, e, p); // Login
                    else 
                        await createUserWithEmailAndPassword(AUTH, e, p); // Registro
                } catch(err) { 
                    btn.disabled = false; btn.innerText = "TENTAR NOVAMENTE"; 
                    errorDiv.classList.remove('hidden'); 
                    errorDiv.innerText = err.code.includes('password') ? "Senha incorreta" : (err.code.includes('email-already-in-use') ? "Email j√° cadastrado." : "Erro: " + err.code); 
                }
            },
            handleLogout: () => signOut(AUTH).then(()=>location.reload())
        };
    </script>
</body>
</html>


